(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{637:function(l,c,Z){"use strict";Z.r(c);var g=Z(1),d=Object(g.a)({},(function(){var l=this,c=l.$createElement,Z=l._self._c||c;return Z("ContentSlotsDistributor",{attrs:{"slot-key":l.$parent.slotKey}},[Z("h1",{attrs:{id:"gas-and-fees"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#gas-and-fees"}},[l._v("#")]),l._v(" Gas and Fees")]),l._v(" "),Z("p",{attrs:{synopsis:""}},[l._v("Learn about the differences between "),Z("code",[l._v("Gas")]),l._v(" and "),Z("code",[l._v("Fees")]),l._v(" in Ethereum and Cosmos.")]),l._v(" "),Z("h2",{attrs:{id:"pre-requisite-readings"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisite-readings"}},[l._v("#")]),l._v(" Pre-requisite Readings")]),l._v(" "),Z("ul",[Z("li",{attrs:{prereq:""}},[Z("a",{attrs:{href:"https://docs.cosmos.network/master/basics/gas-fees.html",target:"_blank",rel:"noopener noreferrer"}},[l._v("Cosmos SDK Gas"),Z("OutboundLink")],1)]),l._v(" "),Z("li",{attrs:{prereq:""}},[Z("a",{attrs:{href:"https://ethereum.org/en/developers/docs/gas/",target:"_blank",rel:"noopener noreferrer"}},[l._v("Ethereum Gas"),Z("OutboundLink")],1)])]),l._v(" "),Z("p",[l._v("The concept of Gas represents the amount of computational effort required to execute specific operations on the state machine.")]),l._v(" "),Z("p",[l._v("Gas was created on Ethereum to disallow the EVM (Ethereum Virtual Machine) from running infinite\nloops by allocating a small amount of monetary value into the system. A unit of gas, usually in the\nform of a fraction of the native coin, is consumed for every operation on the EVM and requires a\nuser to pay for these operations. These operations consist in state transitions such as sending a\ntransaction or calling a contract.")]),l._v(" "),Z("p",[l._v("Exactly like Ethereum, Cosmos utilizes the concept of gas and this is how Cosmos tracks the resource\nusage of operations during execution. Operations on Cosmos are represented as read or writes done to the chain's store.")]),l._v(" "),Z("p",[l._v("In Cosmos, a fee is calculated and charged to the user during a message execution. This fee is\ncalculated from the sum of all gas consumed in a message execution:")]),l._v(" "),Z("p",[Z("span",{staticClass:"katex-display"},[Z("span",{staticClass:"katex"},[Z("span",{staticClass:"katex-mathml"},[Z("math",[Z("semantics",[Z("mrow",[Z("mi",[l._v("f")]),Z("mi",[l._v("e")]),Z("mi",[l._v("e")]),Z("mo",[l._v("=")]),Z("mi",[l._v("g")]),Z("mi",[l._v("a")]),Z("mi",[l._v("s")]),Z("mtext"),Z("mo",[l._v("∗")]),Z("mtext"),Z("mi",[l._v("g")]),Z("mi",[l._v("a")]),Z("mi",[l._v("s")]),Z("mi",[l._v("P")]),Z("mi",[l._v("r")]),Z("mi",[l._v("i")]),Z("mi",[l._v("c")]),Z("mi",[l._v("e")])],1),Z("annotation",{attrs:{encoding:"application/x-tex"}},[l._v("fee = gas ~ * ~ gasPrice\n")])],1)],1)],1),Z("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[Z("span",{staticClass:"strut",staticStyle:{height:"0.69444em"}}),Z("span",{staticClass:"strut bottom",staticStyle:{height:"0.8888799999999999em","vertical-align":"-0.19444em"}}),Z("span",{staticClass:"base displaystyle textstyle uncramped"},[Z("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.10764em"}},[l._v("f")]),Z("span",{staticClass:"mord mathit"},[l._v("e")]),Z("span",{staticClass:"mord mathit"},[l._v("e")]),Z("span",{staticClass:"mrel"},[l._v("=")]),Z("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03588em"}},[l._v("g")]),Z("span",{staticClass:"mord mathit"},[l._v("a")]),Z("span",{staticClass:"mord mathit"},[l._v("s")]),Z("span",{staticClass:"mord mspace"}),Z("span",{staticClass:"mbin"},[l._v("∗")]),Z("span",{staticClass:"mord mspace"}),Z("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03588em"}},[l._v("g")]),Z("span",{staticClass:"mord mathit"},[l._v("a")]),Z("span",{staticClass:"mord mathit"},[l._v("s")]),Z("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[l._v("P")]),Z("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[l._v("r")]),Z("span",{staticClass:"mord mathit"},[l._v("i")]),Z("span",{staticClass:"mord mathit"},[l._v("c")]),Z("span",{staticClass:"mord mathit"},[l._v("e")])])])])])]),l._v(" "),Z("p",[l._v("In both networks, gas is used to make sure that operations do not require an excess amount of\ncomputational power to complete and as a way to deter bad-acting users from spamming the network.")]),l._v(" "),Z("h2",{attrs:{id:"cosmos-sdk-gas"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#cosmos-sdk-gas"}},[l._v("#")]),l._v(" Cosmos SDK "),Z("code",[l._v("Gas")])]),l._v(" "),Z("p",[l._v("In the Cosmos SDK, gas is tracked in the main "),Z("code",[l._v("GasMeter")]),l._v(" and the "),Z("code",[l._v("BlockGasMeter")]),l._v(":")]),l._v(" "),Z("ul",[Z("li",[Z("code",[l._v("GasMeter")]),l._v(": keeps track of the gas consumed during executions that lead to state transitions. It is reset on every transaction execution.")]),l._v(" "),Z("li",[Z("code",[l._v("BlockGasMeter")]),l._v(": keeps track of the gas consumed in a block and enforces that the gas does not go over a predefined limit. This limit is defined in the Tendermint consensus parameters and can be changed via governance parameter change proposals.")])]),l._v(" "),Z("p",[l._v("More information regarding gas in Cosmos SDK can be found "),Z("a",{attrs:{href:"https://docs.cosmos.network/master/basics/gas-fees.html",target:"_blank",rel:"noopener noreferrer"}},[l._v("here"),Z("OutboundLink")],1),l._v(".")]),l._v(" "),Z("h2",{attrs:{id:"matching-evm-gas-consumption"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#matching-evm-gas-consumption"}},[l._v("#")]),l._v(" Matching EVM Gas consumption")]),l._v(" "),Z("p",[l._v("Haqq is an EVM-compatible chain that supports Ethereum Web3 tooling. For this reason, gas\nconsumption must be equitable with other EVMs, most importantly Ethereum.")]),l._v(" "),Z("p",[l._v("The main difference between EVM and Cosmos state transitions, is that the EVM uses a "),Z("a",{attrs:{href:"https://github.com/ethereum/go-ethereum/blob/master/params/protocol_params.go",target:"_blank",rel:"noopener noreferrer"}},[l._v("gas table"),Z("OutboundLink")],1),l._v(" for each OPCODE, whereas Cosmos uses a "),Z("code",[l._v("GasConfig")]),l._v(" that charges gas for each CRUD operation by setting a flat and per-byte cost for accessing the database.")]),l._v(" "),Z("p",[Z("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gR2FzQ29uZmlnIGRlZmluZXMgZ2FzIGNvc3QgZm9yIGVhY2ggb3BlcmF0aW9uIG9uIEtWU3RvcmVzCnR5cGUgR2FzQ29uZmlnIHN0cnVjdCB7CglIYXNDb3N0ICAgICAgICAgIEdhcwoJRGVsZXRlQ29zdCAgICAgICBHYXMKCVJlYWRDb3N0RmxhdCAgICAgR2FzCglSZWFkQ29zdFBlckJ5dGUgIEdhcwoJV3JpdGVDb3N0RmxhdCAgICBHYXMKCVdyaXRlQ29zdFBlckJ5dGUgR2FzCglJdGVyTmV4dENvc3RGbGF0IEdhcwp9"}})],1),l._v(" "),Z("p",[l._v("In order to match the gas consumed by the EVM, the gas consumption logic from the SDK is ignored, and instead the gas consumed is calculated by subtracting the state transition leftover gas plus refund from the gas limit defined on the message.")]),l._v(" "),Z("p",[l._v("To ignore the SDK gas consumption, we reset the transaction "),Z("code",[l._v("GasMeter")]),l._v(" count to 0 and manually set it to the "),Z("code",[l._v("gasUsed")]),l._v(" value computed by the EVM module at the end of the execution.")]),l._v(" "),Z("p",[Z("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBrZWVwZXIKCmltcG9ydCAoCgkmcXVvdDttYXRoL2JpZyZxdW90OwoKCWVycm9yc21vZCAmcXVvdDtjb3Ntb3NzZGsuaW8vZXJyb3JzJnF1b3Q7CglzZGsgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay90eXBlcyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb21tb24mcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY29yZSZxdW90OwoJZXRodHlwZXMgJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb3JlL3R5cGVzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvcmUvdm0mcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY3J5cHRvJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL3BhcmFtcyZxdW90OwoJdG10eXBlcyAmcXVvdDtnaXRodWIuY29tL3RlbmRlcm1pbnQvdGVuZGVybWludC90eXBlcyZxdW90OwoKCWhhcXF0eXBlcyAmcXVvdDtnaXRodWIuY29tL2hhcXEtbmV0d29yay9oYXFxL3R5cGVzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2hhcXEtbmV0d29yay9oYXFxL3gvZXZtL3N0YXRlZGImcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vaGFxcS1uZXR3b3JrL2hhcXEveC9ldm0vdHlwZXMmcXVvdDsKKQoKLy8gTmV3RVZNIGdlbmVyYXRlcyBhIGdvLWV0aGVyZXVtIFZNIGZyb20gdGhlIHByb3ZpZGVkIE1lc3NhZ2UgZmllbGRzIGFuZCB0aGUgY2hhaW4gcGFyYW1ldGVycwovLyAoQ2hhaW5Db25maWcgYW5kIG1vZHVsZSBQYXJhbXMpLiBJdCBhZGRpdGlvbmFsbHkgc2V0cyB0aGUgdmFsaWRhdG9yIG9wZXJhdG9yIGFkZHJlc3MgYXMgdGhlCi8vIGNvaW5iYXNlIGFkZHJlc3MgdG8gbWFrZSBpdCBhdmFpbGFibGUgZm9yIHRoZSBDT0lOQkFTRSBvcGNvZGUsIGV2ZW4gdGhvdWdoIHRoZXJlIGlzIG5vCi8vIGJlbmVmaWNpYXJ5IG9mIHRoZSBjb2luYmFzZSB0cmFuc2FjdGlvbiAoc2luY2Ugd2UncmUgbm90IG1pbmluZykuCi8vCi8vIE5PVEU6IHRoZSBSQU5ET00gb3Bjb2RlIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIHNpbmNlIGl0IHJlcXVpcmVzCi8vIFJBTkRBTyBpbXBsZW1lbnRhdGlvbi4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ldm1vcy9ldGhlcm1pbnQvcHVsbC8xNTIwI3B1bGxyZXF1ZXN0cmV2aWV3LTEyMDA1MDQ2OTcKLy8gZm9yIG1vcmUgaW5mb3JtYXRpb24uCgpmdW5jIChrICpLZWVwZXIpIE5ld0VWTSgKCWN0eCBzZGsuQ29udGV4dCwKCW1zZyBjb3JlLk1lc3NhZ2UsCgljZmcgKnN0YXRlZGIuRVZNQ29uZmlnLAoJdHJhY2VyIHZtLkVWTUxvZ2dlciwKCXN0YXRlREIgdm0uU3RhdGVEQiwKKSAqdm0uRVZNIHsKCWJsb2NrQ3R4IDo9IHZtLkJsb2NrQ29udGV4dHsKCQlDYW5UcmFuc2ZlcjogY29yZS5DYW5UcmFuc2ZlciwKCQlUcmFuc2ZlcjogICAgY29yZS5UcmFuc2ZlciwKCQlHZXRIYXNoOiAgICAgay5HZXRIYXNoRm4oY3R4KSwKCQlDb2luYmFzZTogICAgY2ZnLkNvaW5CYXNlLAoJCUdhc0xpbWl0OiAgICBoYXFxdHlwZXMuQmxvY2tHYXNMaW1pdChjdHgpLAoJCUJsb2NrTnVtYmVyOiBiaWcuTmV3SW50KGN0eC5CbG9ja0hlaWdodCgpKSwKCQlUaW1lOiAgICAgICAgYmlnLk5ld0ludChjdHguQmxvY2tIZWFkZXIoKS5UaW1lLlVuaXgoKSksCgkJRGlmZmljdWx0eTogIGJpZy5OZXdJbnQoMCksIC8vIHVudXNlZC4gT25seSByZXF1aXJlZCBpbiBQb1cgY29udGV4dAoJCUJhc2VGZWU6ICAgICBjZmcuQmFzZUZlZSwKCQlSYW5kb206ICAgICAgbmlsLCAvLyBub3Qgc3VwcG9ydGVkCgl9CgoJdHhDdHggOj0gY29yZS5OZXdFVk1UeENvbnRleHQobXNnKQoJaWYgdHJhY2VyID09IG5pbCB7CgkJdHJhY2VyID0gay5UcmFjZXIoY3R4LCBtc2csIGNmZy5DaGFpbkNvbmZpZykKCX0KCXZtQ29uZmlnIDo9IGsuVk1Db25maWcoY3R4LCBtc2csIGNmZywgdHJhY2VyKQoJcmV0dXJuIHZtLk5ld0VWTShibG9ja0N0eCwgdHhDdHgsIHN0YXRlREIsIGNmZy5DaGFpbkNvbmZpZywgdm1Db25maWcpCn0KCi8vIEdldEhhc2hGbiBpbXBsZW1lbnRzIHZtLkdldEhhc2hGdW5jIGZvciBFdGhlcm1pbnQuIEl0IGhhbmRsZXMgMyBjYXNlczoKLy8gIDEuIFRoZSByZXF1ZXN0ZWQgaGVpZ2h0IG1hdGNoZXMgdGhlIGN1cnJlbnQgaGVpZ2h0IGZyb20gY29udGV4dCAoYW5kIHRodXMgc2FtZSBlcG9jaCBudW1iZXIpCi8vICAyLiBUaGUgcmVxdWVzdGVkIGhlaWdodCBpcyBmcm9tIGFuIHByZXZpb3VzIGhlaWdodCBmcm9tIHRoZSBzYW1lIGNoYWluIGVwb2NoCi8vICAzLiBUaGUgcmVxdWVzdGVkIGhlaWdodCBpcyBmcm9tIGEgaGVpZ2h0IGdyZWF0ZXIgdGhhbiB0aGUgbGF0ZXN0IG9uZQpmdW5jIChrIEtlZXBlcikgR2V0SGFzaEZuKGN0eCBzZGsuQ29udGV4dCkgdm0uR2V0SGFzaEZ1bmMgewoJcmV0dXJuIGZ1bmMoaGVpZ2h0IHVpbnQ2NCkgY29tbW9uLkhhc2ggewoJCWgsIGVyciA6PSBoYXFxdHlwZXMuU2FmZUludDY0KGhlaWdodCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJay5Mb2dnZXIoY3R4KS5FcnJvcigmcXVvdDtmYWlsZWQgdG8gY2FzdCBoZWlnaHQgdG8gaW50NjQmcXVvdDssICZxdW90O2Vycm9yJnF1b3Q7LCBlcnIpCgkJCXJldHVybiBjb21tb24uSGFzaHt9CgkJfQoKCQlzd2l0Y2ggewoJCWNhc2UgY3R4LkJsb2NrSGVpZ2h0KCkgPT0gaDoKCQkJLy8gQ2FzZSAxOiBUaGUgcmVxdWVzdGVkIGhlaWdodCBtYXRjaGVzIHRoZSBvbmUgZnJvbSB0aGUgY29udGV4dCBzbyB3ZSBjYW4gcmV0cmlldmUgdGhlIGhlYWRlcgoJCQkvLyBoYXNoIGRpcmVjdGx5IGZyb20gdGhlIGNvbnRleHQuCgkJCS8vIE5vdGU6IFRoZSBoZWFkZXJIYXNoIGlzIG9ubHkgc2V0IGF0IGJlZ2luIGJsb2NrLCBpdCB3aWxsIGJlIG5pbCBpbiBjYXNlIG9mIGEgcXVlcnkgY29udGV4dAoJCQloZWFkZXJIYXNoIDo9IGN0eC5IZWFkZXJIYXNoKCkKCQkJaWYgbGVuKGhlYWRlckhhc2gpICE9IDAgewoJCQkJcmV0dXJuIGNvbW1vbi5CeXRlc1RvSGFzaChoZWFkZXJIYXNoKQoJCQl9CgoJCQkvLyBvbmx5IHJlY29tcHV0ZSB0aGUgaGFzaCBpZiBub3Qgc2V0IChlZzogY2hlY2tUeFN0YXRlKQoJCQljb250ZXh0QmxvY2tIZWFkZXIgOj0gY3R4LkJsb2NrSGVhZGVyKCkKCQkJaGVhZGVyLCBlcnIgOj0gdG10eXBlcy5IZWFkZXJGcm9tUHJvdG8oJmFtcDtjb250ZXh0QmxvY2tIZWFkZXIpCgkJCWlmIGVyciAhPSBuaWwgewoJCQkJay5Mb2dnZXIoY3R4KS5FcnJvcigmcXVvdDtmYWlsZWQgdG8gY2FzdCB0ZW5kZXJtaW50IGhlYWRlciBmcm9tIHByb3RvJnF1b3Q7LCAmcXVvdDtlcnJvciZxdW90OywgZXJyKQoJCQkJcmV0dXJuIGNvbW1vbi5IYXNoe30KCQkJfQoKCQkJaGVhZGVySGFzaCA9IGhlYWRlci5IYXNoKCkKCQkJcmV0dXJuIGNvbW1vbi5CeXRlc1RvSGFzaChoZWFkZXJIYXNoKQoKCQljYXNlIGN0eC5CbG9ja0hlaWdodCgpICZndDsgaDoKCQkJLy8gQ2FzZSAyOiBpZiB0aGUgY2hhaW4gaXMgbm90IHRoZSBjdXJyZW50IGhlaWdodCB3ZSBuZWVkIHRvIHJldHJpZXZlIHRoZSBoYXNoIGZyb20gdGhlIHN0b3JlIGZvciB0aGUKCQkJLy8gY3VycmVudCBjaGFpbiBlcG9jaC4gVGhpcyBvbmx5IGFwcGxpZXMgaWYgdGhlIGN1cnJlbnQgaGVpZ2h0IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVxdWVzdGVkIGhlaWdodC4KCQkJaGlzdEluZm8sIGZvdW5kIDo9IGsuc3Rha2luZ0tlZXBlci5HZXRIaXN0b3JpY2FsSW5mbyhjdHgsIGgpCgkJCWlmICFmb3VuZCB7CgkJCQlrLkxvZ2dlcihjdHgpLkRlYnVnKCZxdW90O2hpc3RvcmljYWwgaW5mbyBub3QgZm91bmQmcXVvdDssICZxdW90O2hlaWdodCZxdW90OywgaCkKCQkJCXJldHVybiBjb21tb24uSGFzaHt9CgkJCX0KCgkJCWhlYWRlciwgZXJyIDo9IHRtdHlwZXMuSGVhZGVyRnJvbVByb3RvKCZhbXA7aGlzdEluZm8uSGVhZGVyKQoJCQlpZiBlcnIgIT0gbmlsIHsKCQkJCWsuTG9nZ2VyKGN0eCkuRXJyb3IoJnF1b3Q7ZmFpbGVkIHRvIGNhc3QgdGVuZGVybWludCBoZWFkZXIgZnJvbSBwcm90byZxdW90OywgJnF1b3Q7ZXJyb3ImcXVvdDssIGVycikKCQkJCXJldHVybiBjb21tb24uSGFzaHt9CgkJCX0KCgkJCXJldHVybiBjb21tb24uQnl0ZXNUb0hhc2goaGVhZGVyLkhhc2goKSkKCQlkZWZhdWx0OgoJCQkvLyBDYXNlIDM6IGhlaWdodHMgZ3JlYXRlciB0aGFuIHRoZSBjdXJyZW50IG9uZSByZXR1cm5zIGFuIGVtcHR5IGhhc2guCgkJCXJldHVybiBjb21tb24uSGFzaHt9CgkJfQoJfQp9CgovLyBBcHBseVRyYW5zYWN0aW9uIHJ1bnMgYW5kIGF0dGVtcHRzIHRvIHBlcmZvcm0gYSBzdGF0ZSB0cmFuc2l0aW9uIHdpdGggdGhlIGdpdmVuIHRyYW5zYWN0aW9uIChpLmUgTWVzc2FnZSksIHRoYXQgd2lsbAovLyBvbmx5IGJlIHBlcnNpc3RlZCAoY29tbWl0dGVkKSB0byB0aGUgdW5kZXJseWluZyBLVlN0b3JlIGlmIHRoZSB0cmFuc2FjdGlvbiBkb2VzIG5vdCBmYWlsLgovLwovLyAjIEdhcyB0cmFja2luZwovLwovLyBFdGhlcmV1bSBjb25zdW1lcyBnYXMgYWNjb3JkaW5nIHRvIHRoZSBFVk0gb3Bjb2RlcyBpbnN0ZWFkIG9mIGdlbmVyYWwgcmVhZHMgYW5kIHdyaXRlcyB0byBzdG9yZS4gQmVjYXVzZSBvZiB0aGlzLCB0aGUKLy8gc3RhdGUgdHJhbnNpdGlvbiBuZWVkcyB0byBpZ25vcmUgdGhlIFNESyBnYXMgY29uc3VtcHRpb24gbWVjaGFuaXNtIGRlZmluZWQgYnkgdGhlIEdhc0tWU3RvcmUgYW5kIGluc3RlYWQgY29uc3VtZSB0aGUKLy8gYW1vdW50IG9mIGdhcyB1c2VkIGJ5IHRoZSBWTSBleGVjdXRpb24uIFRoZSBhbW91bnQgb2YgZ2FzIHVzZWQgaXMgdHJhY2tlZCBieSB0aGUgRVZNIGFuZCByZXR1cm5lZCBpbiB0aGUgZXhlY3V0aW9uCi8vIHJlc3VsdC4KLy8KLy8gUHJpb3IgdG8gdGhlIGV4ZWN1dGlvbiwgdGhlIHN0YXJ0aW5nIHR4IGdhcyBtZXRlciBpcyBzYXZlZCBhbmQgcmVwbGFjZWQgd2l0aCBhbiBpbmZpbml0ZSBnYXMgbWV0ZXIgaW4gYSBuZXcgY29udGV4dAovLyBpbiBvcmRlciB0byBpZ25vcmUgdGhlIFNESyBnYXMgY29uc3VtcHRpb24gY29uZmlnIHZhbHVlcyAocmVhZCwgd3JpdGUsIGhhcywgZGVsZXRlKS4KLy8gQWZ0ZXIgdGhlIGV4ZWN1dGlvbiwgdGhlIGdhcyB1c2VkIGZyb20gdGhlIG1lc3NhZ2UgZXhlY3V0aW9uIHdpbGwgYmUgYWRkZWQgdG8gdGhlIHN0YXJ0aW5nIGdhcyBjb25zdW1lZCwgdGFraW5nIGludG8KLy8gY29uc2lkZXJhdGlvbiB0aGUgYW1vdW50IG9mIGdhcyByZXR1cm5lZC4gRmluYWxseSwgdGhlIGNvbnRleHQgaXMgdXBkYXRlZCB3aXRoIHRoZSBFVk0gZ2FzIGNvbnN1bWVkIHZhbHVlIHByaW9yIHRvCi8vIHJldHVybmluZy4KLy8KLy8gRm9yIHJlbGV2YW50IGRpc2N1c3Npb24gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvZGlzY3Vzc2lvbnMvOTA3MgpmdW5jIChrICpLZWVwZXIpIEFwcGx5VHJhbnNhY3Rpb24oY3R4IHNkay5Db250ZXh0LCB0eCAqZXRodHlwZXMuVHJhbnNhY3Rpb24pICgqdHlwZXMuTXNnRXRoZXJldW1UeFJlc3BvbnNlLCBlcnJvcikgewoJdmFyICgKCQlibG9vbSAgICAgICAgKmJpZy5JbnQKCQlibG9vbVJlY2VpcHQgZXRodHlwZXMuQmxvb20KCSkKCgljZmcsIGVyciA6PSBrLkVWTUNvbmZpZyhjdHgsIHNkay5Db25zQWRkcmVzcyhjdHguQmxvY2tIZWFkZXIoKS5Qcm9wb3NlckFkZHJlc3MpLCBrLmVpcDE1NUNoYWluSUQpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBlcnJvcnNtb2QuV3JhcChlcnIsICZxdW90O2ZhaWxlZCB0byBsb2FkIGV2bSBjb25maWcmcXVvdDspCgl9Cgl0eENvbmZpZyA6PSBrLlR4Q29uZmlnKGN0eCwgdHguSGFzaCgpKQoKCS8vIGdldCB0aGUgc2lnbmVyIGFjY29yZGluZyB0byB0aGUgY2hhaW4gcnVsZXMgZnJvbSB0aGUgY29uZmlnIGFuZCBibG9jayBoZWlnaHQKCXNpZ25lciA6PSBldGh0eXBlcy5NYWtlU2lnbmVyKGNmZy5DaGFpbkNvbmZpZywgYmlnLk5ld0ludChjdHguQmxvY2tIZWlnaHQoKSkpCgltc2csIGVyciA6PSB0eC5Bc01lc3NhZ2Uoc2lnbmVyLCBjZmcuQmFzZUZlZSkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIGVycm9yc21vZC5XcmFwKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIHJldHVybiBldGhlcmV1bSB0cmFuc2FjdGlvbiBhcyBjb3JlIG1lc3NhZ2UmcXVvdDspCgl9CgoJLy8gc25hcHNob3QgdG8gY29udGFpbiB0aGUgdHggcHJvY2Vzc2luZyBhbmQgcG9zdCBwcm9jZXNzaW5nIGluIHNhbWUgc2NvcGUKCXZhciBjb21taXQgZnVuYygpCgl0bXBDdHggOj0gY3R4CglpZiBrLmhvb2tzICE9IG5pbCB7CgkJLy8gQ3JlYXRlIGEgY2FjaGUgY29udGV4dCB0byByZXZlcnQgc3RhdGUgd2hlbiB0eCBob29rcyBmYWlscywKCQkvLyB0aGUgY2FjaGUgY29udGV4dCBpcyBvbmx5IGNvbW1pdHRlZCB3aGVuIGJvdGggdHggYW5kIGhvb2tzIGV4ZWN1dGVkIHN1Y2Nlc3NmdWxseS4KCQkvLyBEaWRuJ3QgdXNlIGBTbmFwc2hvdGAgYmVjYXVzZSB0aGUgY29udGV4dCBzdGFjayBoYXMgZXhwb25lbnRpYWwgY29tcGxleGl0eSBvbiBjZXJ0YWluIG9wZXJhdGlvbnMsCgkJLy8gdGh1cyByZXN0cmljdGVkIHRvIGJlIHVzZWQgb25seSBpbnNpZGUgYEFwcGx5TWVzc2FnZWAuCgkJdG1wQ3R4LCBjb21taXQgPSBjdHguQ2FjaGVDb250ZXh0KCkKCX0KCgkvLyBwYXNzIHRydWUgdG8gY29tbWl0IHRoZSBTdGF0ZURCCglyZXMsIGVyciA6PSBrLkFwcGx5TWVzc2FnZVdpdGhDb25maWcodG1wQ3R4LCBtc2csIG5pbCwgdHJ1ZSwgY2ZnLCB0eENvbmZpZykKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIGVycm9yc21vZC5XcmFwKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIGFwcGx5IGV0aGVyZXVtIGNvcmUgbWVzc2FnZSZxdW90OykKCX0KCglsb2dzIDo9IHR5cGVzLkxvZ3NUb0V0aGVyZXVtKHJlcy5Mb2dzKQoKCS8vIENvbXB1dGUgYmxvY2sgYmxvb20gZmlsdGVyCglpZiBsZW4obG9ncykgJmd0OyAwIHsKCQlibG9vbSA9IGsuR2V0QmxvY2tCbG9vbVRyYW5zaWVudChjdHgpCgkJYmxvb20uT3IoYmxvb20sIGJpZy5OZXdJbnQoMCkuU2V0Qnl0ZXMoZXRodHlwZXMuTG9nc0Jsb29tKGxvZ3MpKSkKCQlibG9vbVJlY2VpcHQgPSBldGh0eXBlcy5CeXRlc1RvQmxvb20oYmxvb20uQnl0ZXMoKSkKCX0KCgljdW11bGF0aXZlR2FzVXNlZCA6PSByZXMuR2FzVXNlZAoJaWYgY3R4LkJsb2NrR2FzTWV0ZXIoKSAhPSBuaWwgewoJCWxpbWl0IDo9IGN0eC5CbG9ja0dhc01ldGVyKCkuTGltaXQoKQoJCWN1bXVsYXRpdmVHYXNVc2VkICs9IGN0eC5CbG9ja0dhc01ldGVyKCkuR2FzQ29uc3VtZWQoKQoJCWlmIGN1bXVsYXRpdmVHYXNVc2VkICZndDsgbGltaXQgewoJCQljdW11bGF0aXZlR2FzVXNlZCA9IGxpbWl0CgkJfQoJfQoKCXZhciBjb250cmFjdEFkZHIgY29tbW9uLkFkZHJlc3MKCWlmIG1zZy5UbygpID09IG5pbCB7CgkJY29udHJhY3RBZGRyID0gY3J5cHRvLkNyZWF0ZUFkZHJlc3MobXNnLkZyb20oKSwgbXNnLk5vbmNlKCkpCgl9CgoJcmVjZWlwdCA6PSAmYW1wO2V0aHR5cGVzLlJlY2VpcHR7CgkJVHlwZTogICAgICAgICAgICAgIHR4LlR5cGUoKSwKCQlQb3N0U3RhdGU6ICAgICAgICAgbmlsLCAvLyBUT0RPOiBpbnRlcm1lZGlhdGUgc3RhdGUgcm9vdAoJCUN1bXVsYXRpdmVHYXNVc2VkOiBjdW11bGF0aXZlR2FzVXNlZCwKCQlCbG9vbTogICAgICAgICAgICAgYmxvb21SZWNlaXB0LAoJCUxvZ3M6ICAgICAgICAgICAgICBsb2dzLAoJCVR4SGFzaDogICAgICAgICAgICB0eENvbmZpZy5UeEhhc2gsCgkJQ29udHJhY3RBZGRyZXNzOiAgIGNvbnRyYWN0QWRkciwKCQlHYXNVc2VkOiAgICAgICAgICAgcmVzLkdhc1VzZWQsCgkJQmxvY2tIYXNoOiAgICAgICAgIHR4Q29uZmlnLkJsb2NrSGFzaCwKCQlCbG9ja051bWJlcjogICAgICAgYmlnLk5ld0ludChjdHguQmxvY2tIZWlnaHQoKSksCgkJVHJhbnNhY3Rpb25JbmRleDogIHR4Q29uZmlnLlR4SW5kZXgsCgl9CgoJaWYgIXJlcy5GYWlsZWQoKSB7CgkJcmVjZWlwdC5TdGF0dXMgPSBldGh0eXBlcy5SZWNlaXB0U3RhdHVzU3VjY2Vzc2Z1bAoJCS8vIE9ubHkgY2FsbCBob29rcyBpZiB0eCBleGVjdXRlZCBzdWNjZXNzZnVsbHkuCgkJaWYgZXJyID0gay5Qb3N0VHhQcm9jZXNzaW5nKHRtcEN0eCwgbXNnLCByZWNlaXB0KTsgZXJyICE9IG5pbCB7CgkJCS8vIElmIGhvb2tzIHJldHVybiBlcnJvciwgcmV2ZXJ0IHRoZSB3aG9sZSB0eC4KCQkJcmVzLlZtRXJyb3IgPSB0eXBlcy5FcnJQb3N0VHhQcm9jZXNzaW5nLkVycm9yKCkKCQkJay5Mb2dnZXIoY3R4KS5FcnJvcigmcXVvdDt0eCBwb3N0IHByb2Nlc3NpbmcgZmFpbGVkJnF1b3Q7LCAmcXVvdDtlcnJvciZxdW90OywgZXJyKQoKCQkJLy8gSWYgdGhlIHR4IGZhaWxlZCBpbiBwb3N0IHByb2Nlc3NpbmcgaG9va3MsIHdlIHNob3VsZCBjbGVhciB0aGUgbG9ncwoJCQlyZXMuTG9ncyA9IG5pbAoJCX0gZWxzZSBpZiBjb21taXQgIT0gbmlsIHsKCQkJLy8gUG9zdFR4UHJvY2Vzc2luZyBpcyBzdWNjZXNzZnVsLCBjb21taXQgdGhlIHRtcEN0eAoJCQljb21taXQoKQoJCQkvLyBTaW5jZSB0aGUgcG9zdC1wcm9jZXNzaW5nIGNhbiBhbHRlciB0aGUgbG9nLCB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgcmVzdWx0CgkJCXJlcy5Mb2dzID0gdHlwZXMuTmV3TG9nc0Zyb21FdGgocmVjZWlwdC5Mb2dzKQoJCQljdHguRXZlbnRNYW5hZ2VyKCkuRW1pdEV2ZW50cyh0bXBDdHguRXZlbnRNYW5hZ2VyKCkuRXZlbnRzKCkpCgkJfQoJfQoKCS8vIHJlZnVuZCBnYXMgaW4gb3JkZXIgdG8gbWF0Y2ggdGhlIEV0aGVyZXVtIGdhcyBjb25zdW1wdGlvbiBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IFNESyBvbmUuCglpZiBlcnIgPSBrLlJlZnVuZEdhcyhjdHgsIG1zZywgbXNnLkdhcygpLXJlcy5HYXNVc2VkLCBjZmcuUGFyYW1zLkV2bURlbm9tKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgZXJyb3JzbW9kLldyYXBmKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIHJlZnVuZCBnYXMgbGVmdG92ZXIgZ2FzIHRvIHNlbmRlciAlcyZxdW90OywgbXNnLkZyb20oKSkKCX0KCglpZiBsZW4ocmVjZWlwdC5Mb2dzKSAmZ3Q7IDAgewoJCS8vIFVwZGF0ZSB0cmFuc2llbnQgYmxvY2sgYmxvb20gZmlsdGVyCgkJay5TZXRCbG9ja0Jsb29tVHJhbnNpZW50KGN0eCwgcmVjZWlwdC5CbG9vbS5CaWcoKSkKCQlrLlNldExvZ1NpemVUcmFuc2llbnQoY3R4LCB1aW50NjQodHhDb25maWcuTG9nSW5kZXgpK3VpbnQ2NChsZW4ocmVjZWlwdC5Mb2dzKSkpCgl9CgoJay5TZXRUeEluZGV4VHJhbnNpZW50KGN0eCwgdWludDY0KHR4Q29uZmlnLlR4SW5kZXgpKzEpCgoJdG90YWxHYXNVc2VkLCBlcnIgOj0gay5BZGRUcmFuc2llbnRHYXNVc2VkKGN0eCwgcmVzLkdhc1VzZWQpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBlcnJvcnNtb2QuV3JhcChlcnIsICZxdW90O2ZhaWxlZCB0byBhZGQgdHJhbnNpZW50IGdhcyB1c2VkJnF1b3Q7KQoJfQoKCS8vIHJlc2V0IHRoZSBnYXMgbWV0ZXIgZm9yIGN1cnJlbnQgY29zbW9zIHRyYW5zYWN0aW9uCglrLlJlc2V0R2FzTWV0ZXJBbmRDb25zdW1lR2FzKGN0eCwgdG90YWxHYXNVc2VkKQoJcmV0dXJuIHJlcywgbmlsCn0KCi8vIEFwcGx5TWVzc2FnZSBjYWxscyBBcHBseU1lc3NhZ2VXaXRoQ29uZmlnIHdpdGggYW4gZW1wdHkgVHhDb25maWcuCmZ1bmMgKGsgKktlZXBlcikgQXBwbHlNZXNzYWdlKGN0eCBzZGsuQ29udGV4dCwgbXNnIGNvcmUuTWVzc2FnZSwgdHJhY2VyIHZtLkVWTUxvZ2dlciwgY29tbWl0IGJvb2wpICgqdHlwZXMuTXNnRXRoZXJldW1UeFJlc3BvbnNlLCBlcnJvcikgewoJY2ZnLCBlcnIgOj0gay5FVk1Db25maWcoY3R4LCBzZGsuQ29uc0FkZHJlc3MoY3R4LkJsb2NrSGVhZGVyKCkuUHJvcG9zZXJBZGRyZXNzKSwgay5laXAxNTVDaGFpbklEKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgZXJyb3JzbW9kLldyYXAoZXJyLCAmcXVvdDtmYWlsZWQgdG8gbG9hZCBldm0gY29uZmlnJnF1b3Q7KQoJfQoKCXR4Q29uZmlnIDo9IHN0YXRlZGIuTmV3RW1wdHlUeENvbmZpZyhjb21tb24uQnl0ZXNUb0hhc2goY3R4LkhlYWRlckhhc2goKSkpCglyZXR1cm4gay5BcHBseU1lc3NhZ2VXaXRoQ29uZmlnKGN0eCwgbXNnLCB0cmFjZXIsIGNvbW1pdCwgY2ZnLCB0eENvbmZpZykKfQoKLy8gQXBwbHlNZXNzYWdlV2l0aENvbmZpZyBjb21wdXRlcyB0aGUgbmV3IHN0YXRlIGJ5IGFwcGx5aW5nIHRoZSBnaXZlbiBtZXNzYWdlIGFnYWluc3QgdGhlIGV4aXN0aW5nIHN0YXRlLgovLyBJZiB0aGUgbWVzc2FnZSBmYWlscywgdGhlIFZNIGV4ZWN1dGlvbiBlcnJvciB3aXRoIHRoZSByZWFzb24gd2lsbCBiZSByZXR1cm5lZCB0byB0aGUgY2xpZW50Ci8vIGFuZCB0aGUgdHJhbnNhY3Rpb24gd29uJ3QgYmUgY29tbWl0dGVkIHRvIHRoZSBzdG9yZS4KLy8KLy8gIyBSZXZlcnRlZCBzdGF0ZQovLwovLyBUaGUgc25hcHNob3QgYW5kIHJvbGxiYWNrIGFyZSBzdXBwb3J0ZWQgYnkgdGhlIGBzdGF0ZWRiLlN0YXRlREJgLgovLwovLyAjIERpZmZlcmVudCBDYWxsZXJzCi8vCi8vIEl0J3MgY2FsbGVkIGluIHRocmVlIHNjZW5hcmlvczoKLy8gMS4gYEFwcGx5VHJhbnNhY3Rpb25gLCBpbiB0aGUgdHJhbnNhY3Rpb24gcHJvY2Vzc2luZyBmbG93LgovLyAyLiBgRXRoQ2FsbC9FdGhFc3RpbWF0ZUdhc2AgZ3JwYyBxdWVyeSBoYW5kbGVyLgovLyAzLiBDYWxsZWQgYnkgb3RoZXIgbmF0aXZlIG1vZHVsZXMgZGlyZWN0bHkuCi8vCi8vICMgUHJlY2hlY2tzIGFuZCBQcmVwcm9jZXNzaW5nCi8vCi8vIEFsbCByZWxldmFudCBzdGF0ZSB0cmFuc2l0aW9uIHByZWNoZWNrcyBmb3IgdGhlIE1zZ0V0aGVyZXVtVHggYXJlIHBlcmZvcm1lZCBvbiB0aGUgQW50ZUhhbmRsZXIsCi8vIHByaW9yIHRvIHJ1bm5pbmcgdGhlIHRyYW5zYWN0aW9uIGFnYWluc3QgdGhlIHN0YXRlLiBUaGUgcHJlY2hlY2tzIHJ1biBhcmUgdGhlIGZvbGxvd2luZzoKLy8KLy8gMS4gdGhlIG5vbmNlIG9mIHRoZSBtZXNzYWdlIGNhbGxlciBpcyBjb3JyZWN0Ci8vIDIuIGNhbGxlciBoYXMgZW5vdWdoIGJhbGFuY2UgdG8gY292ZXIgdHJhbnNhY3Rpb24gZmVlKGdhc2xpbWl0ICogZ2FzcHJpY2UpCi8vIDMuIHRoZSBhbW91bnQgb2YgZ2FzIHJlcXVpcmVkIGlzIGF2YWlsYWJsZSBpbiB0aGUgYmxvY2sKLy8gNC4gdGhlIHB1cmNoYXNlZCBnYXMgaXMgZW5vdWdoIHRvIGNvdmVyIGludHJpbnNpYyB1c2FnZQovLyA1LiB0aGVyZSBpcyBubyBvdmVyZmxvdyB3aGVuIGNhbGN1bGF0aW5nIGludHJpbnNpYyBnYXMKLy8gNi4gY2FsbGVyIGhhcyBlbm91Z2ggYmFsYW5jZSB0byBjb3ZlciBhc3NldCB0cmFuc2ZlciBmb3IgKip0b3Btb3N0KiogY2FsbAovLwovLyBUaGUgcHJlcHJvY2Vzc2luZyBzdGVwcyBwZXJmb3JtZWQgYnkgdGhlIEFudGVIYW5kbGVyIGFyZToKLy8KLy8gMS4gc2V0IHVwIHRoZSBpbml0aWFsIGFjY2VzcyBsaXN0IChpZmYgZm9yayAmZ3Q7IEJlcmxpbikKLy8KLy8gIyBUcmFjZXIgcGFyYW1ldGVyCi8vCi8vIEl0IHNob3VsZCBiZSBhIGB2bS5UcmFjZXJgIG9iamVjdCBvciBuaWwsIGlmIHBhc3MgYG5pbGAsIGl0J2xsIGNyZWF0ZSBhIGRlZmF1bHQgb25lIGJhc2VkIG9uIGtlZXBlciBvcHRpb25zLgovLwovLyAjIENvbW1pdCBwYXJhbWV0ZXIKLy8KLy8gSWYgY29tbWl0IGlzIHRydWUsIHRoZSBgU3RhdGVEQmAgd2lsbCBiZSBjb21taXR0ZWQsIG90aGVyd2lzZSBkaXNjYXJkZWQuCmZ1bmMgKGsgKktlZXBlcikgQXBwbHlNZXNzYWdlV2l0aENvbmZpZyhjdHggc2RrLkNvbnRleHQsCgltc2cgY29yZS5NZXNzYWdlLAoJdHJhY2VyIHZtLkVWTUxvZ2dlciwKCWNvbW1pdCBib29sLAoJY2ZnICpzdGF0ZWRiLkVWTUNvbmZpZywKCXR4Q29uZmlnIHN0YXRlZGIuVHhDb25maWcsCikgKCp0eXBlcy5Nc2dFdGhlcmV1bVR4UmVzcG9uc2UsIGVycm9yKSB7Cgl2YXIgKAoJCXJldCAgIFtdYnl0ZSAvLyByZXR1cm4gYnl0ZXMgZnJvbSBldm0gZXhlY3V0aW9uCgkJdm1FcnIgZXJyb3IgIC8vIHZtIGVycm9ycyBkbyBub3QgZWZmZWN0IGNvbnNlbnN1cyBhbmQgYXJlIHRoZXJlZm9yZSBub3QgYXNzaWduZWQgdG8gZXJyCgkpCgoJLy8gcmV0dXJuIGVycm9yIGlmIGNvbnRyYWN0IGNyZWF0aW9uIG9yIGNhbGwgYXJlIGRpc2FibGVkIHRocm91Z2ggZ292ZXJuYW5jZQoJaWYgIWNmZy5QYXJhbXMuRW5hYmxlQ3JlYXRlICZhbXA7JmFtcDsgbXNnLlRvKCkgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBlcnJvcnNtb2QuV3JhcCh0eXBlcy5FcnJDcmVhdGVEaXNhYmxlZCwgJnF1b3Q7ZmFpbGVkIHRvIGNyZWF0ZSBuZXcgY29udHJhY3QmcXVvdDspCgl9IGVsc2UgaWYgIWNmZy5QYXJhbXMuRW5hYmxlQ2FsbCAmYW1wOyZhbXA7IG1zZy5UbygpICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgZXJyb3JzbW9kLldyYXAodHlwZXMuRXJyQ2FsbERpc2FibGVkLCAmcXVvdDtmYWlsZWQgdG8gY2FsbCBjb250cmFjdCZxdW90OykKCX0KCglzdGF0ZURCIDo9IHN0YXRlZGIuTmV3KGN0eCwgaywgdHhDb25maWcpCglldm0gOj0gay5OZXdFVk0oY3R4LCBtc2csIGNmZywgdHJhY2VyLCBzdGF0ZURCKQoKCWxlZnRvdmVyR2FzIDo9IG1zZy5HYXMoKQoKCS8vIEFsbG93IHRoZSB0cmFjZXIgY2FwdHVyZXMgdGhlIHR4IGxldmVsIGV2ZW50cywgbWFpbmx5IHRoZSBnYXMgY29uc3VtcHRpb24uCgl2bUNmZyA6PSBldm0uQ29uZmlnCglpZiB2bUNmZy5EZWJ1ZyB7CgkJdm1DZmcuVHJhY2VyLkNhcHR1cmVUeFN0YXJ0KGxlZnRvdmVyR2FzKQoJCWRlZmVyIGZ1bmMoKSB7CgkJCXZtQ2ZnLlRyYWNlci5DYXB0dXJlVHhFbmQobGVmdG92ZXJHYXMpCgkJfSgpCgl9CgoJc2VuZGVyIDo9IHZtLkFjY291bnRSZWYobXNnLkZyb20oKSkKCWNvbnRyYWN0Q3JlYXRpb24gOj0gbXNnLlRvKCkgPT0gbmlsCglpc0xvbmRvbiA6PSBjZmcuQ2hhaW5Db25maWcuSXNMb25kb24oZXZtLkNvbnRleHQuQmxvY2tOdW1iZXIpCgoJaW50cmluc2ljR2FzLCBlcnIgOj0gay5HZXRFdGhJbnRyaW5zaWNHYXMoY3R4LCBtc2csIGNmZy5DaGFpbkNvbmZpZywgY29udHJhY3RDcmVhdGlvbikKCWlmIGVyciAhPSBuaWwgewoJCS8vIHNob3VsZCBoYXZlIGFscmVhZHkgYmVlbiBjaGVja2VkIG9uIEFudGUgSGFuZGxlcgoJCXJldHVybiBuaWwsIGVycm9yc21vZC5XcmFwKGVyciwgJnF1b3Q7aW50cmluc2ljIGdhcyBmYWlsZWQmcXVvdDspCgl9CgoJLy8gU2hvdWxkIGNoZWNrIGFnYWluIGV2ZW4gaWYgaXQgaXMgY2hlY2tlZCBvbiBBbnRlIEhhbmRsZXIsIGJlY2F1c2UgZXRoX2NhbGwgZG9uJ3QgZ28gdGhyb3VnaCBBbnRlIEhhbmRsZXIuCglpZiBsZWZ0b3ZlckdhcyAmbHQ7IGludHJpbnNpY0dhcyB7CgkJLy8gZXRoX2VzdGltYXRlR2FzIHdpbGwgY2hlY2sgZm9yIHRoaXMgZXhhY3QgZXJyb3IKCQlyZXR1cm4gbmlsLCBlcnJvcnNtb2QuV3JhcChjb3JlLkVyckludHJpbnNpY0dhcywgJnF1b3Q7YXBwbHkgbWVzc2FnZSZxdW90OykKCX0KCWxlZnRvdmVyR2FzIC09IGludHJpbnNpY0dhcwoKCS8vIGFjY2VzcyBsaXN0IHByZXBhcmF0aW9uIGlzIG1vdmVkIGZyb20gYW50ZSBoYW5kbGVyIHRvIGhlcmUsIGJlY2F1c2UgaXQncyBuZWVkZWQgd2hlbiBgQXBwbHlNZXNzYWdlYCBpcyBjYWxsZWQKCS8vIHVuZGVyIGNvbnRleHRzIHdoZXJlIGFudGUgaGFuZGxlcnMgYXJlIG5vdCBydW4sIGZvciBleGFtcGxlIGBldGhfY2FsbGAgYW5kIGBldGhfZXN0aW1hdGVHYXNgLgoJaWYgcnVsZXMgOj0gY2ZnLkNoYWluQ29uZmlnLlJ1bGVzKGJpZy5OZXdJbnQoY3R4LkJsb2NrSGVpZ2h0KCkpLCBjZmcuQ2hhaW5Db25maWcuTWVyZ2VOZXRzcGxpdEJsb2NrICE9IG5pbCk7IHJ1bGVzLklzQmVybGluIHsKCQlzdGF0ZURCLlByZXBhcmVBY2Nlc3NMaXN0KG1zZy5Gcm9tKCksIG1zZy5UbygpLCB2bS5BY3RpdmVQcmVjb21waWxlcyhydWxlcyksIG1zZy5BY2Nlc3NMaXN0KCkpCgl9CgoJaWYgY29udHJhY3RDcmVhdGlvbiB7CgkJLy8gdGFrZSBvdmVyIHRoZSBub25jZSBtYW5hZ2VtZW50IGZyb20gZXZtOgoJCS8vIC0gcmVzZXQgc2VuZGVyJ3Mgbm9uY2UgdG8gbXNnLk5vbmNlKCkgYmVmb3JlIGNhbGxpbmcgZXZtLgoJCS8vIC0gaW5jcmVhc2Ugc2VuZGVyJ3Mgbm9uY2UgYnkgb25lIG5vIG1hdHRlciB0aGUgcmVzdWx0LgoJCXN0YXRlREIuU2V0Tm9uY2Uoc2VuZGVyLkFkZHJlc3MoKSwgbXNnLk5vbmNlKCkpCgkJcmV0LCBfLCBsZWZ0b3Zlckdhcywgdm1FcnIgPSBldm0uQ3JlYXRlKHNlbmRlciwgbXNnLkRhdGEoKSwgbGVmdG92ZXJHYXMsIG1zZy5WYWx1ZSgpKQoJCXN0YXRlREIuU2V0Tm9uY2Uoc2VuZGVyLkFkZHJlc3MoKSwgbXNnLk5vbmNlKCkrMSkKCX0gZWxzZSB7CgkJcmV0LCBsZWZ0b3Zlckdhcywgdm1FcnIgPSBldm0uQ2FsbChzZW5kZXIsICptc2cuVG8oKSwgbXNnLkRhdGEoKSwgbGVmdG92ZXJHYXMsIG1zZy5WYWx1ZSgpKQoJfQoKCXJlZnVuZFF1b3RpZW50IDo9IHBhcmFtcy5SZWZ1bmRRdW90aWVudAoKCS8vIEFmdGVyIEVJUC0zNTI5OiByZWZ1bmRzIGFyZSBjYXBwZWQgdG8gZ2FzVXNlZCAvIDUKCWlmIGlzTG9uZG9uIHsKCQlyZWZ1bmRRdW90aWVudCA9IHBhcmFtcy5SZWZ1bmRRdW90aWVudEVJUDM1MjkKCX0KCgkvLyBjYWxjdWxhdGUgZ2FzIHJlZnVuZAoJaWYgbXNnLkdhcygpICZsdDsgbGVmdG92ZXJHYXMgewoJCXJldHVybiBuaWwsIGVycm9yc21vZC5XcmFwKHR5cGVzLkVyckdhc092ZXJmbG93LCAmcXVvdDthcHBseSBtZXNzYWdlJnF1b3Q7KQoJfQoJLy8gcmVmdW5kIGdhcwoJdGVtcG9yYXJ5R2FzVXNlZCA6PSBtc2cuR2FzKCkgLSBsZWZ0b3ZlckdhcwoJcmVmdW5kIDo9IEdhc1RvUmVmdW5kKHN0YXRlREIuR2V0UmVmdW5kKCksIHRlbXBvcmFyeUdhc1VzZWQsIHJlZnVuZFF1b3RpZW50KQoKCS8vIHVwZGF0ZSBsZWZ0b3ZlckdhcyBhbmQgdGVtcG9yYXJ5R2FzVXNlZCB3aXRoIHJlZnVuZCBhbW91bnQKCWxlZnRvdmVyR2FzICs9IHJlZnVuZAoJdGVtcG9yYXJ5R2FzVXNlZCAtPSByZWZ1bmQKCgkvLyBFVk0gZXhlY3V0aW9uIGVycm9yIG5lZWRzIHRvIGJlIGF2YWlsYWJsZSBmb3IgdGhlIEpTT04tUlBDIGNsaWVudAoJdmFyIHZtRXJyb3Igc3RyaW5nCglpZiB2bUVyciAhPSBuaWwgewoJCXZtRXJyb3IgPSB2bUVyci5FcnJvcigpCgl9CgoJLy8gVGhlIGRpcnR5IHN0YXRlcyBpbiBgU3RhdGVEQmAgaXMgZWl0aGVyIGNvbW1pdHRlZCBvciBkaXNjYXJkZWQgYWZ0ZXIgcmV0dXJuCglpZiBjb21taXQgewoJCWlmIGVyciA6PSBzdGF0ZURCLkNvbW1pdCgpOyBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuIG5pbCwgZXJyb3JzbW9kLldyYXAoZXJyLCAmcXVvdDtmYWlsZWQgdG8gY29tbWl0IHN0YXRlREImcXVvdDspCgkJfQoJfQoKCS8vIGNhbGN1bGF0ZSBhIG1pbmltdW0gYW1vdW50IG9mIGdhcyB0byBiZSBjaGFyZ2VkIHRvIHNlbmRlciBpZiBHYXNMaW1pdAoJLy8gaXMgY29uc2lkZXJhYmx5IGhpZ2hlciB0aGFuIEdhc1VzZWQgdG8gc3RheSBtb3JlIGFsaWduZWQgd2l0aCBUZW5kZXJtaW50IGdhcyBtZWNoYW5pY3MKCS8vIGZvciBtb3JlIGluZm8gaHR0cHM6Ly9naXRodWIuY29tL2V2bW9zL2V0aGVybWludC9pc3N1ZXMvMTA4NQoJZ2FzTGltaXQgOj0gc2RrLk5ld0RlYyhpbnQ2NChtc2cuR2FzKCkpKQoJbWluR2FzTXVsdGlwbGllciA6PSBrLkdldE1pbkdhc011bHRpcGxpZXIoY3R4KQoJbWluaW11bUdhc1VzZWQgOj0gZ2FzTGltaXQuTXVsKG1pbkdhc011bHRpcGxpZXIpCgoJaWYgbXNnLkdhcygpICZsdDsgbGVmdG92ZXJHYXMgewoJCXJldHVybiBuaWwsIGVycm9yc21vZC5XcmFwZih0eXBlcy5FcnJHYXNPdmVyZmxvdywgJnF1b3Q7bWVzc2FnZSBnYXMgbGltaXQgJmx0OyBsZWZ0b3ZlciBnYXMgKCVkICZsdDsgJWQpJnF1b3Q7LCBtc2cuR2FzKCksIGxlZnRvdmVyR2FzKQoJfQoKCWdhc1VzZWQgOj0gc2RrLk1heERlYyhtaW5pbXVtR2FzVXNlZCwgc2RrLk5ld0RlYyhpbnQ2NCh0ZW1wb3JhcnlHYXNVc2VkKSkpLlRydW5jYXRlSW50KCkuVWludDY0KCkKCS8vIHJlc2V0IGxlZnRvdmVyR2FzLCB0byBiZSB1c2VkIGJ5IHRoZSB0cmFjZXIKCWxlZnRvdmVyR2FzID0gbXNnLkdhcygpIC0gZ2FzVXNlZAoKCXJldHVybiAmYW1wO3R5cGVzLk1zZ0V0aGVyZXVtVHhSZXNwb25zZXsKCQlHYXNVc2VkOiBnYXNVc2VkLAoJCVZtRXJyb3I6IHZtRXJyb3IsCgkJUmV0OiAgICAgcmV0LAoJCUxvZ3M6ICAgIHR5cGVzLk5ld0xvZ3NGcm9tRXRoKHN0YXRlREIuTG9ncygpKSwKCQlIYXNoOiAgICB0eENvbmZpZy5UeEhhc2guSGV4KCksCgl9LCBuaWwKfQo="}})],1),l._v(" "),Z("h3",{attrs:{id:"antehandler"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#antehandler"}},[l._v("#")]),l._v(" "),Z("code",[l._v("AnteHandler")])]),l._v(" "),Z("p",[l._v("The Cosmos SDK "),Z("a",{attrs:{href:"https://docs.cosmos.network/master/basics/gas-fees.html#antehandler",target:"_blank",rel:"noopener noreferrer"}},[Z("code",[l._v("AnteHandler")]),Z("OutboundLink")],1),l._v("\nperforms basic checks prior to transaction execution. These checks are usually signature\nverification, transaction field validation, transaction fees, etc.")]),l._v(" "),Z("p",[l._v("Regarding gas consumption and fees, the "),Z("code",[l._v("AnteHandler")]),l._v(" checks that the user has enough balance to\ncover for the tx cost (amount plus fees) as well as checking that the gas limit defined in the\nmessage is greater or equal than the computed intrinsic gas for the message.")]),l._v(" "),Z("h2",{attrs:{id:"gas-refunds"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#gas-refunds"}},[l._v("#")]),l._v(" Gas Refunds")]),l._v(" "),Z("p",[l._v("In the EVM, gas can be specified prior to execution. The totality of the gas specified is consumed at the beginning of the execution (during the "),Z("code",[l._v("AnteHandler")]),l._v(" step) and the remaining gas is refunded back to\nthe user if any gas is left over after the execution. Additionally the EVM can also define gas to be refunded back to the user but those will be capped to a fraction of the used gas depending on the fork/version being used.")]),l._v(" "),Z("h2",{attrs:{id:"_0-fee-transactions"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#_0-fee-transactions"}},[l._v("#")]),l._v(" 0 Fee Transactions")]),l._v(" "),Z("p",[l._v("In Cosmos, a minimum gas price is not enforced by the "),Z("code",[l._v("AnteHandler")]),l._v(" as the "),Z("code",[l._v("min-gas-prices")]),l._v(" is\nchecked against the local node/validator. In other words, the minimum fees accepted are determined\nby the validators of the network, and each validator can specify a different minimum value for their fees.\nThis potentially allows end users to submit 0 fee transactions if there is at least one single\nvalidator that is willing to include transactions with "),Z("code",[l._v("0")]),l._v(" gas price in their blocks proposed.")]),l._v(" "),Z("p",[l._v("For this same reason, in Haqq it is possible to send transactions with "),Z("code",[l._v("0")]),l._v(" fees for transaction\ntypes other than the ones defined by the "),Z("code",[l._v("evm")]),l._v(" module. EVM module transactions cannot have "),Z("code",[l._v("0")]),l._v(" fees\nas gas is required inherently by the EVM. This check is done by the EVM transactions stateless validation\n(i.e "),Z("code",[l._v("ValidateBasic")]),l._v(") function as well as on the custom "),Z("code",[l._v("AnteHandler")]),l._v(" defined by Haqq.")]),l._v(" "),Z("h2",{attrs:{id:"gas-estimation"}},[Z("a",{staticClass:"header-anchor",attrs:{href:"#gas-estimation"}},[l._v("#")]),l._v(" Gas estimation")]),l._v(" "),Z("p",[l._v("Ethereum provides a JSON-RPC endpoint "),Z("code",[l._v("eth_estimateGas")]),l._v(" to help users set up a correct gas limit in their transactions.")]),l._v(" "),Z("p",[l._v("Unfortunately, we cannot make use of the SDK "),Z("code",[l._v("tx simulation")]),l._v(" for gas estimation because the pre-check in the Ante Handlers would require a valid signature, and the sender balance to be enough to pay for the gas. But in Ethereum, this endpoint can be called without specifying any sender address.")]),l._v(" "),Z("p",[l._v("For that reason, a specific query API "),Z("code",[l._v("EstimateGas")]),l._v(" is implemented in Haqq. It will apply the transaction against the current block/state and perform a binary search in order to find the optimal gas value to return to the user (the same transaction will be applied over and over until we find the minimum gas needed before it fails). The reason we need to use a binary search is that the gas required for the\ntransaction might be higher than the value returned by the EVM after applying the transaction, so we need to try until we find the optimal value.")]),l._v(" "),Z("p",[l._v("A cache context will be used during the whole execution to avoid changes be persisted in the state.")]),l._v(" "),Z("p",[Z("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBrZWVwZXIKCmltcG9ydCAoCgkmcXVvdDtjb250ZXh0JnF1b3Q7CgkmcXVvdDtlbmNvZGluZy9qc29uJnF1b3Q7CgkmcXVvdDtlcnJvcnMmcXVvdDsKCSZxdW90O2ZtdCZxdW90OwoJJnF1b3Q7bWF0aC9iaWcmcXVvdDsKCSZxdW90O3RpbWUmcXVvdDsKCgkmcXVvdDtnb29nbGUuZ29sYW5nLm9yZy9ncnBjL2NvZGVzJnF1b3Q7CgkmcXVvdDtnb29nbGUuZ29sYW5nLm9yZy9ncnBjL3N0YXR1cyZxdW90OwoKCXNka21hdGggJnF1b3Q7Y29zbW9zc2RrLmlvL21hdGgmcXVvdDsKCXNkayAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvbW1vbiZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb21tb24vaGV4dXRpbCZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb3JlJnF1b3Q7CglldGh0eXBlcyAmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvcmUvdHlwZXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY29yZS92bSZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9ldGgvdHJhY2VycyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9ldGgvdHJhY2Vycy9sb2dnZXImcXVvdDsKCWV0aHBhcmFtcyAmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL3BhcmFtcyZxdW90OwoKCWhhcXF0eXBlcyAmcXVvdDtnaXRodWIuY29tL2hhcXEtbmV0d29yay9oYXFxL3R5cGVzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2hhcXEtbmV0d29yay9oYXFxL3gvZXZtL3N0YXRlZGImcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vaGFxcS1uZXR3b3JrL2hhcXEveC9ldm0vdHlwZXMmcXVvdDsKKQoKdmFyIF8gdHlwZXMuUXVlcnlTZXJ2ZXIgPSBLZWVwZXJ7fQoKY29uc3QgKAoJZGVmYXVsdFRyYWNlVGltZW91dCA9IDUgKiB0aW1lLlNlY29uZAopCgovLyBBY2NvdW50IGltcGxlbWVudHMgdGhlIFF1ZXJ5L0FjY291bnQgZ1JQQyBtZXRob2QKZnVuYyAoayBLZWVwZXIpIEFjY291bnQoYyBjb250ZXh0LkNvbnRleHQsIHJlcSAqdHlwZXMuUXVlcnlBY2NvdW50UmVxdWVzdCkgKCp0eXBlcy5RdWVyeUFjY291bnRSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJaWYgZXJyIDo9IGhhcXF0eXBlcy5WYWxpZGF0ZUFkZHJlc3MocmVxLkFkZHJlc3MpOyBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwgZXJyLkVycm9yKCksCgkJKQoJfQoKCWFkZHIgOj0gY29tbW9uLkhleFRvQWRkcmVzcyhyZXEuQWRkcmVzcykKCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWFjY3QgOj0gay5HZXRBY2NvdW50T3JFbXB0eShjdHgsIGFkZHIpCgoJcmV0dXJuICZhbXA7dHlwZXMuUXVlcnlBY2NvdW50UmVzcG9uc2V7CgkJQmFsYW5jZTogIGFjY3QuQmFsYW5jZS5TdHJpbmcoKSwKCQlDb2RlSGFzaDogY29tbW9uLkJ5dGVzVG9IYXNoKGFjY3QuQ29kZUhhc2gpLkhleCgpLAoJCU5vbmNlOiAgICBhY2N0Lk5vbmNlLAoJfSwgbmlsCn0KCmZ1bmMgKGsgS2VlcGVyKSBDb3Ntb3NBY2NvdW50KGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5Q29zbW9zQWNjb3VudFJlcXVlc3QpICgqdHlwZXMuUXVlcnlDb3Ntb3NBY2NvdW50UmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWlmIGVyciA6PSBoYXFxdHlwZXMuVmFsaWRhdGVBZGRyZXNzKHJlcS5BZGRyZXNzKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQljb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCglldGhBZGRyIDo9IGNvbW1vbi5IZXhUb0FkZHJlc3MocmVxLkFkZHJlc3MpCgljb3Ntb3NBZGRyIDo9IHNkay5BY2NBZGRyZXNzKGV0aEFkZHIuQnl0ZXMoKSkKCglhY2NvdW50IDo9IGsuYWNjb3VudEtlZXBlci5HZXRBY2NvdW50KGN0eCwgY29zbW9zQWRkcikKCXJlcyA6PSB0eXBlcy5RdWVyeUNvc21vc0FjY291bnRSZXNwb25zZXsKCQlDb3Ntb3NBZGRyZXNzOiBjb3Ntb3NBZGRyLlN0cmluZygpLAoJfQoKCWlmIGFjY291bnQgIT0gbmlsIHsKCQlyZXMuU2VxdWVuY2UgPSBhY2NvdW50LkdldFNlcXVlbmNlKCkKCQlyZXMuQWNjb3VudE51bWJlciA9IGFjY291bnQuR2V0QWNjb3VudE51bWJlcigpCgl9CgoJcmV0dXJuICZhbXA7cmVzLCBuaWwKfQoKLy8gVmFsaWRhdG9yQWNjb3VudCBpbXBsZW1lbnRzIHRoZSBRdWVyeS9CYWxhbmNlIGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBWYWxpZGF0b3JBY2NvdW50KGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5VmFsaWRhdG9yQWNjb3VudFJlcXVlc3QpICgqdHlwZXMuUXVlcnlWYWxpZGF0b3JBY2NvdW50UmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWNvbnNBZGRyLCBlcnIgOj0gc2RrLkNvbnNBZGRyZXNzRnJvbUJlY2gzMihyZXEuQ29uc0FkZHJlc3MpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwgZXJyLkVycm9yKCksCgkJKQoJfQoKCWN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjKQoKCXZhbGlkYXRvciwgZm91bmQgOj0gay5zdGFraW5nS2VlcGVyLkdldFZhbGlkYXRvckJ5Q29uc0FkZHIoY3R4LCBjb25zQWRkcikKCWlmICFmb3VuZCB7CgkJcmV0dXJuIG5pbCwgZm10LkVycm9yZigmcXVvdDt2YWxpZGF0b3Igbm90IGZvdW5kIGZvciAlcyZxdW90OywgY29uc0FkZHIuU3RyaW5nKCkpCgl9CgoJYWNjQWRkciA6PSBzZGsuQWNjQWRkcmVzcyh2YWxpZGF0b3IuR2V0T3BlcmF0b3IoKSkKCglyZXMgOj0gdHlwZXMuUXVlcnlWYWxpZGF0b3JBY2NvdW50UmVzcG9uc2V7CgkJQWNjb3VudEFkZHJlc3M6IGFjY0FkZHIuU3RyaW5nKCksCgl9CgoJYWNjb3VudCA6PSBrLmFjY291bnRLZWVwZXIuR2V0QWNjb3VudChjdHgsIGFjY0FkZHIpCglpZiBhY2NvdW50ICE9IG5pbCB7CgkJcmVzLlNlcXVlbmNlID0gYWNjb3VudC5HZXRTZXF1ZW5jZSgpCgkJcmVzLkFjY291bnROdW1iZXIgPSBhY2NvdW50LkdldEFjY291bnROdW1iZXIoKQoJfQoKCXJldHVybiAmYW1wO3JlcywgbmlsCn0KCi8vIEJhbGFuY2UgaW1wbGVtZW50cyB0aGUgUXVlcnkvQmFsYW5jZSBnUlBDIG1ldGhvZApmdW5jIChrIEtlZXBlcikgQmFsYW5jZShjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5RdWVyeUJhbGFuY2VSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5QmFsYW5jZVJlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCglpZiBlcnIgOj0gaGFxcXR5cGVzLlZhbGlkYXRlQWRkcmVzcyhyZXEuQWRkcmVzcyk7IGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcigKCQkJY29kZXMuSW52YWxpZEFyZ3VtZW50LAoJCQl0eXBlcy5FcnJaZXJvQWRkcmVzcy5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCgliYWxhbmNlSW50IDo9IGsuR2V0QmFsYW5jZShjdHgsIGNvbW1vbi5IZXhUb0FkZHJlc3MocmVxLkFkZHJlc3MpKQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5QmFsYW5jZVJlc3BvbnNlewoJCUJhbGFuY2U6IGJhbGFuY2VJbnQuU3RyaW5nKCksCgl9LCBuaWwKfQoKLy8gU3RvcmFnZSBpbXBsZW1lbnRzIHRoZSBRdWVyeS9TdG9yYWdlIGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBTdG9yYWdlKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5U3RvcmFnZVJlcXVlc3QpICgqdHlwZXMuUXVlcnlTdG9yYWdlUmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWlmIGVyciA6PSBoYXFxdHlwZXMuVmFsaWRhdGVBZGRyZXNzKHJlcS5BZGRyZXNzKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQljb2Rlcy5JbnZhbGlkQXJndW1lbnQsCgkJCXR5cGVzLkVyclplcm9BZGRyZXNzLkVycm9yKCksCgkJKQoJfQoKCWN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjKQoKCWFkZHJlc3MgOj0gY29tbW9uLkhleFRvQWRkcmVzcyhyZXEuQWRkcmVzcykKCWtleSA6PSBjb21tb24uSGV4VG9IYXNoKHJlcS5LZXkpCgoJc3RhdGUgOj0gay5HZXRTdGF0ZShjdHgsIGFkZHJlc3MsIGtleSkKCXN0YXRlSGV4IDo9IHN0YXRlLkhleCgpCgoJcmV0dXJuICZhbXA7dHlwZXMuUXVlcnlTdG9yYWdlUmVzcG9uc2V7CgkJVmFsdWU6IHN0YXRlSGV4LAoJfSwgbmlsCn0KCi8vIENvZGUgaW1wbGVtZW50cyB0aGUgUXVlcnkvQ29kZSBnUlBDIG1ldGhvZApmdW5jIChrIEtlZXBlcikgQ29kZShjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5RdWVyeUNvZGVSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5Q29kZVJlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCglpZiBlcnIgOj0gaGFxcXR5cGVzLlZhbGlkYXRlQWRkcmVzcyhyZXEuQWRkcmVzcyk7IGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcigKCQkJY29kZXMuSW52YWxpZEFyZ3VtZW50LAoJCQl0eXBlcy5FcnJaZXJvQWRkcmVzcy5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCglhZGRyZXNzIDo9IGNvbW1vbi5IZXhUb0FkZHJlc3MocmVxLkFkZHJlc3MpCglhY2N0IDo9IGsuR2V0QWNjb3VudFdpdGhvdXRCYWxhbmNlKGN0eCwgYWRkcmVzcykKCgl2YXIgY29kZSBbXWJ5dGUKCWlmIGFjY3QgIT0gbmlsICZhbXA7JmFtcDsgYWNjdC5Jc0NvbnRyYWN0KCkgewoJCWNvZGUgPSBrLkdldENvZGUoY3R4LCBjb21tb24uQnl0ZXNUb0hhc2goYWNjdC5Db2RlSGFzaCkpCgl9CgoJcmV0dXJuICZhbXA7dHlwZXMuUXVlcnlDb2RlUmVzcG9uc2V7CgkJQ29kZTogY29kZSwKCX0sIG5pbAp9CgovLyBQYXJhbXMgaW1wbGVtZW50cyB0aGUgUXVlcnkvUGFyYW1zIGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBQYXJhbXMoYyBjb250ZXh0LkNvbnRleHQsIF8gKnR5cGVzLlF1ZXJ5UGFyYW1zUmVxdWVzdCkgKCp0eXBlcy5RdWVyeVBhcmFtc1Jlc3BvbnNlLCBlcnJvcikgewoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCglwYXJhbXMgOj0gay5HZXRQYXJhbXMoY3R4KQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5UGFyYW1zUmVzcG9uc2V7CgkJUGFyYW1zOiBwYXJhbXMsCgl9LCBuaWwKfQoKLy8gRXRoQ2FsbCBpbXBsZW1lbnRzIGV0aF9jYWxsIHJwYyBhcGkuCmZ1bmMgKGsgS2VlcGVyKSBFdGhDYWxsKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLkV0aENhbGxSZXF1ZXN0KSAoKnR5cGVzLk1zZ0V0aGVyZXVtVHhSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCgoJdmFyIGFyZ3MgdHlwZXMuVHJhbnNhY3Rpb25BcmdzCgllcnIgOj0ganNvbi5Vbm1hcnNoYWwocmVxLkFyZ3MsICZhbXA7YXJncykKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoJY2hhaW5JRCwgZXJyIDo9IGdldENoYWluSUQoY3R4LCByZXEuQ2hhaW5JZCkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoJY2ZnLCBlcnIgOj0gay5FVk1Db25maWcoY3R4LCBHZXRQcm9wb3NlckFkZHJlc3MoY3R4LCByZXEuUHJvcG9zZXJBZGRyZXNzKSwgY2hhaW5JRCkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgl9CgoJLy8gQXBwbHlNZXNzYWdlV2l0aENvbmZpZyBleHBlY3QgY29ycmVjdCBub25jZSBzZXQgaW4gbXNnCglub25jZSA6PSBrLkdldE5vbmNlKGN0eCwgYXJncy5HZXRGcm9tKCkpCglhcmdzLk5vbmNlID0gKCpoZXh1dGlsLlVpbnQ2NCkoJmFtcDtub25jZSkKCgltc2csIGVyciA6PSBhcmdzLlRvTWVzc2FnZShyZXEuR2FzQ2FwLCBjZmcuQmFzZUZlZSkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoKCXR4Q29uZmlnIDo9IHN0YXRlZGIuTmV3RW1wdHlUeENvbmZpZyhjb21tb24uQnl0ZXNUb0hhc2goY3R4LkhlYWRlckhhc2goKSkpCgoJLy8gcGFzcyBmYWxzZSB0byBub3QgY29tbWl0IFN0YXRlREIKCXJlcywgZXJyIDo9IGsuQXBwbHlNZXNzYWdlV2l0aENvbmZpZyhjdHgsIG1zZywgbmlsLCBmYWxzZSwgY2ZnLCB0eENvbmZpZykKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgl9CgoJcmV0dXJuIHJlcywgbmlsCn0KCi8vIEVzdGltYXRlR2FzIGltcGxlbWVudHMgZXRoX2VzdGltYXRlR2FzIHJwYyBhcGkuCmZ1bmMgKGsgS2VlcGVyKSBFc3RpbWF0ZUdhcyhjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5FdGhDYWxsUmVxdWVzdCkgKCp0eXBlcy5Fc3RpbWF0ZUdhc1Jlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWNoYWluSUQsIGVyciA6PSBnZXRDaGFpbklEKGN0eCwgcmVxLkNoYWluSWQpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCBlcnIuRXJyb3IoKSkKCX0KCglpZiByZXEuR2FzQ2FwICZsdDsgZXRocGFyYW1zLlR4R2FzIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtnYXMgY2FwIGNhbm5vdCBiZSBsb3dlciB0aGFuIDIxLDAwMCZxdW90OykKCX0KCgl2YXIgYXJncyB0eXBlcy5UcmFuc2FjdGlvbkFyZ3MKCWVyciA9IGpzb24uVW5tYXJzaGFsKHJlcS5BcmdzLCAmYW1wO2FyZ3MpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCBlcnIuRXJyb3IoKSkKCX0KCgkvLyBCaW5hcnkgc2VhcmNoIHRoZSBnYXMgcmVxdWlyZW1lbnQsIGFzIGl0IG1heSBiZSBoaWdoZXIgdGhhbiB0aGUgYW1vdW50IHVzZWQKCXZhciAoCgkJbG8gICAgID0gZXRocGFyYW1zLlR4R2FzIC0gMQoJCWhpICAgICB1aW50NjQKCQlnYXNDYXAgdWludDY0CgkpCgoJLy8gRGV0ZXJtaW5lIHRoZSBoaWdoZXN0IGdhcyBsaW1pdCBjYW4gYmUgdXNlZCBkdXJpbmcgdGhlIGVzdGltYXRpb24uCglpZiBhcmdzLkdhcyAhPSBuaWwgJmFtcDsmYW1wOyB1aW50NjQoKmFyZ3MuR2FzKSAmZ3Q7PSBldGhwYXJhbXMuVHhHYXMgewoJCWhpID0gdWludDY0KCphcmdzLkdhcykKCX0gZWxzZSB7CgkJLy8gUXVlcnkgYmxvY2sgZ2FzIGxpbWl0CgkJcGFyYW1zIDo9IGN0eC5Db25zZW5zdXNQYXJhbXMoKQoJCWlmIHBhcmFtcyAhPSBuaWwgJmFtcDsmYW1wOyBwYXJhbXMuQmxvY2sgIT0gbmlsICZhbXA7JmFtcDsgcGFyYW1zLkJsb2NrLk1heEdhcyAmZ3Q7IDAgewoJCQloaSA9IHVpbnQ2NChwYXJhbXMuQmxvY2suTWF4R2FzKQoJCX0gZWxzZSB7CgkJCWhpID0gcmVxLkdhc0NhcAoJCX0KCX0KCgkvLyBUT0RPOiBSZWNhcCB0aGUgaGlnaGVzdCBnYXMgbGltaXQgd2l0aCBhY2NvdW50J3MgYXZhaWxhYmxlIGJhbGFuY2UuCgoJLy8gUmVjYXAgdGhlIGhpZ2hlc3QgZ2FzIGFsbG93YW5jZSB3aXRoIHNwZWNpZmllZCBnYXNjYXAuCglpZiByZXEuR2FzQ2FwICE9IDAgJmFtcDsmYW1wOyBoaSAmZ3Q7IHJlcS5HYXNDYXAgewoJCWhpID0gcmVxLkdhc0NhcAoJfQoKCWdhc0NhcCA9IGhpCgljZmcsIGVyciA6PSBrLkVWTUNvbmZpZyhjdHgsIEdldFByb3Bvc2VyQWRkcmVzcyhjdHgsIHJlcS5Qcm9wb3NlckFkZHJlc3MpLCBjaGFpbklEKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCAmcXVvdDtmYWlsZWQgdG8gbG9hZCBldm0gY29uZmlnJnF1b3Q7KQoJfQoKCS8vIEFwcGx5TWVzc2FnZVdpdGhDb25maWcgZXhwZWN0IGNvcnJlY3Qgbm9uY2Ugc2V0IGluIG1zZwoJbm9uY2UgOj0gay5HZXROb25jZShjdHgsIGFyZ3MuR2V0RnJvbSgpKQoJYXJncy5Ob25jZSA9ICgqaGV4dXRpbC5VaW50NjQpKCZhbXA7bm9uY2UpCgoJdHhDb25maWcgOj0gc3RhdGVkYi5OZXdFbXB0eVR4Q29uZmlnKGNvbW1vbi5CeXRlc1RvSGFzaChjdHguSGVhZGVySGFzaCgpLkJ5dGVzKCkpKQoKCS8vIGNvbnZlcnQgdGhlIHR4IGFyZ3MgdG8gYW4gZXRoZXJldW0gbWVzc2FnZQoJbXNnLCBlcnIgOj0gYXJncy5Ub01lc3NhZ2UocmVxLkdhc0NhcCwgY2ZnLkJhc2VGZWUpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCS8vIE5PVEU6IHRoZSBlcnJvcnMgZnJvbSB0aGUgZXhlY3V0YWJsZSBiZWxvdyBzaG91bGQgYmUgY29uc2lzdGVudCB3aXRoIGdvLWV0aGVyZXVtLAoJLy8gc28gd2UgZG9uJ3Qgd3JhcCB0aGVtIHdpdGggdGhlIGdSUEMgc3RhdHVzIGNvZGUKCgkvLyBDcmVhdGUgYSBoZWxwZXIgdG8gY2hlY2sgaWYgYSBnYXMgYWxsb3dhbmNlIHJlc3VsdHMgaW4gYW4gZXhlY3V0YWJsZSB0cmFuc2FjdGlvbgoJZXhlY3V0YWJsZSA6PSBmdW5jKGdhcyB1aW50NjQpICh2bUVycm9yIGJvb2wsIHJzcCAqdHlwZXMuTXNnRXRoZXJldW1UeFJlc3BvbnNlLCBlcnIgZXJyb3IpIHsKCQkvLyB1cGRhdGUgdGhlIG1lc3NhZ2Ugd2l0aCB0aGUgbmV3IGdhcyB2YWx1ZQoJCW1zZyA9IGV0aHR5cGVzLk5ld01lc3NhZ2UoCgkJCW1zZy5Gcm9tKCksCgkJCW1zZy5UbygpLAoJCQltc2cuTm9uY2UoKSwKCQkJbXNnLlZhbHVlKCksCgkJCWdhcywKCQkJbXNnLkdhc1ByaWNlKCksCgkJCW1zZy5HYXNGZWVDYXAoKSwKCQkJbXNnLkdhc1RpcENhcCgpLAoJCQltc2cuRGF0YSgpLAoJCQltc2cuQWNjZXNzTGlzdCgpLAoJCQltc2cuSXNGYWtlKCksCgkJKQoKCQkvLyBwYXNzIGZhbHNlIHRvIG5vdCBjb21taXQgU3RhdGVEQgoJCXJzcCwgZXJyID0gay5BcHBseU1lc3NhZ2VXaXRoQ29uZmlnKGN0eCwgbXNnLCBuaWwsIGZhbHNlLCBjZmcsIHR4Q29uZmlnKQoJCWlmIGVyciAhPSBuaWwgewoJCQlpZiBlcnJvcnMuSXMoZXJyLCBjb3JlLkVyckludHJpbnNpY0dhcykgewoJCQkJcmV0dXJuIHRydWUsIG5pbCwgbmlsIC8vIFNwZWNpYWwgY2FzZSwgcmFpc2UgZ2FzIGxpbWl0CgkJCX0KCQkJcmV0dXJuIHRydWUsIG5pbCwgZXJyIC8vIEJhaWwgb3V0CgkJfQoJCXJldHVybiBsZW4ocnNwLlZtRXJyb3IpICZndDsgMCwgcnNwLCBuaWwKCX0KCgkvLyBFeGVjdXRlIHRoZSBiaW5hcnkgc2VhcmNoIGFuZCBob25lIGluIG9uIGFuIGV4ZWN1dGFibGUgZ2FzIGxpbWl0CgloaSwgZXJyID0gdHlwZXMuQmluU2VhcmNoKGxvLCBoaSwgZXhlY3V0YWJsZSkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIGVycgoJfQoKCS8vIFJlamVjdCB0aGUgdHJhbnNhY3Rpb24gYXMgaW52YWxpZCBpZiBpdCBzdGlsbCBmYWlscyBhdCB0aGUgaGlnaGVzdCBhbGxvd2FuY2UKCWlmIGhpID09IGdhc0NhcCB7CgkJZmFpbGVkLCByZXN1bHQsIGVyciA6PSBleGVjdXRhYmxlKGhpKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gbmlsLCBlcnIKCQl9CgoJCWlmIGZhaWxlZCB7CgkJCWlmIHJlc3VsdCAhPSBuaWwgJmFtcDsmYW1wOyByZXN1bHQuVm1FcnJvciAhPSB2bS5FcnJPdXRPZkdhcy5FcnJvcigpIHsKCQkJCWlmIHJlc3VsdC5WbUVycm9yID09IHZtLkVyckV4ZWN1dGlvblJldmVydGVkLkVycm9yKCkgewoJCQkJCXJldHVybiBuaWwsIHR5cGVzLk5ld0V4ZWNFcnJvcldpdGhSZWFzb24ocmVzdWx0LlJldCkKCQkJCX0KCQkJCXJldHVybiBuaWwsIGVycm9ycy5OZXcocmVzdWx0LlZtRXJyb3IpCgkJCX0KCQkJLy8gT3RoZXJ3aXNlLCB0aGUgc3BlY2lmaWVkIGdhcyBjYXAgaXMgdG9vIGxvdwoJCQlyZXR1cm4gbmlsLCBmbXQuRXJyb3JmKCZxdW90O2dhcyByZXF1aXJlZCBleGNlZWRzIGFsbG93YW5jZSAoJWQpJnF1b3Q7LCBnYXNDYXApCgkJfQoJfQoJcmV0dXJuICZhbXA7dHlwZXMuRXN0aW1hdGVHYXNSZXNwb25zZXtHYXM6IGhpfSwgbmlsCn0KCi8vIFRyYWNlVHggY29uZmlndXJlcyBhIG5ldyB0cmFjZXIgYWNjb3JkaW5nIHRvIHRoZSBwcm92aWRlZCBjb25maWd1cmF0aW9uLCBhbmQKLy8gZXhlY3V0ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgaW4gdGhlIHByb3ZpZGVkIGVudmlyb25tZW50LiBUaGUgcmV0dXJuIHZhbHVlIHdpbGwKLy8gYmUgdHJhY2VyIGRlcGVuZGVudC4KZnVuYyAoayBLZWVwZXIpIFRyYWNlVHgoYyBjb250ZXh0LkNvbnRleHQsIHJlcSAqdHlwZXMuUXVlcnlUcmFjZVR4UmVxdWVzdCkgKCp0eXBlcy5RdWVyeVRyYWNlVHhSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJaWYgcmVxLlRyYWNlQ29uZmlnICE9IG5pbCAmYW1wOyZhbXA7IHJlcS5UcmFjZUNvbmZpZy5MaW1pdCAmbHQ7IDAgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcmYoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtvdXRwdXQgbGltaXQgY2Fubm90IGJlIG5lZ2F0aXZlLCBnb3QgJWQmcXVvdDssIHJlcS5UcmFjZUNvbmZpZy5MaW1pdCkKCX0KCgkvLyBtaW51cyBvbmUgdG8gZ2V0IHRoZSBjb250ZXh0IG9mIGJsb2NrIGJlZ2lubmluZwoJY29udGV4dEhlaWdodCA6PSByZXEuQmxvY2tOdW1iZXIgLSAxCglpZiBjb250ZXh0SGVpZ2h0ICZsdDsgMSB7CgkJLy8gMCBpcyBhIHNwZWNpYWwgdmFsdWUgaW4gYENvbnRleHRXaXRoSGVpZ2h0YAoJCWNvbnRleHRIZWlnaHQgPSAxCgl9CgoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCgljdHggPSBjdHguV2l0aEJsb2NrSGVpZ2h0KGNvbnRleHRIZWlnaHQpCgljdHggPSBjdHguV2l0aEJsb2NrVGltZShyZXEuQmxvY2tUaW1lKQoJY3R4ID0gY3R4LldpdGhIZWFkZXJIYXNoKGNvbW1vbi5IZXgyQnl0ZXMocmVxLkJsb2NrSGFzaCkpCgljaGFpbklELCBlcnIgOj0gZ2V0Q2hhaW5JRChjdHgsIHJlcS5DaGFpbklkKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgZXJyLkVycm9yKCkpCgl9CgljZmcsIGVyciA6PSBrLkVWTUNvbmZpZyhjdHgsIEdldFByb3Bvc2VyQWRkcmVzcyhjdHgsIHJlcS5Qcm9wb3NlckFkZHJlc3MpLCBjaGFpbklEKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yZihjb2Rlcy5JbnRlcm5hbCwgJnF1b3Q7ZmFpbGVkIHRvIGxvYWQgZXZtIGNvbmZpZzogJXMmcXVvdDssIGVyci5FcnJvcigpKQoJfQoJc2lnbmVyIDo9IGV0aHR5cGVzLk1ha2VTaWduZXIoY2ZnLkNoYWluQ29uZmlnLCBiaWcuTmV3SW50KGN0eC5CbG9ja0hlaWdodCgpKSkKCgl0eENvbmZpZyA6PSBzdGF0ZWRiLk5ld0VtcHR5VHhDb25maWcoY29tbW9uLkJ5dGVzVG9IYXNoKGN0eC5IZWFkZXJIYXNoKCkuQnl0ZXMoKSkpCglmb3IgaSwgdHggOj0gcmFuZ2UgcmVxLlByZWRlY2Vzc29ycyB7CgkJZXRoVHggOj0gdHguQXNUcmFuc2FjdGlvbigpCgkJbXNnLCBlcnIgOj0gZXRoVHguQXNNZXNzYWdlKHNpZ25lciwgY2ZnLkJhc2VGZWUpCgkJaWYgZXJyICE9IG5pbCB7CgkJCWNvbnRpbnVlCgkJfQoJCXR4Q29uZmlnLlR4SGFzaCA9IGV0aFR4Lkhhc2goKQoJCXR4Q29uZmlnLlR4SW5kZXggPSB1aW50KGkpCgkJcnNwLCBlcnIgOj0gay5BcHBseU1lc3NhZ2VXaXRoQ29uZmlnKGN0eCwgbXNnLCB0eXBlcy5OZXdOb09wVHJhY2VyKCksIHRydWUsIGNmZywgdHhDb25maWcpCgkJaWYgZXJyICE9IG5pbCB7CgkJCWNvbnRpbnVlCgkJfQoJCXR4Q29uZmlnLkxvZ0luZGV4ICs9IHVpbnQobGVuKHJzcC5Mb2dzKSkKCX0KCgl0eCA6PSByZXEuTXNnLkFzVHJhbnNhY3Rpb24oKQoJdHhDb25maWcuVHhIYXNoID0gdHguSGFzaCgpCglpZiBsZW4ocmVxLlByZWRlY2Vzc29ycykgJmd0OyAwIHsKCQl0eENvbmZpZy5UeEluZGV4KysKCX0KCgl2YXIgdHJhY2VyQ29uZmlnIGpzb24uUmF3TWVzc2FnZQoJaWYgcmVxLlRyYWNlQ29uZmlnICE9IG5pbCAmYW1wOyZhbXA7IHJlcS5UcmFjZUNvbmZpZy5UcmFjZXJKc29uQ29uZmlnICE9ICZxdW90OyZxdW90OyB7CgkJLy8gaWdub3JlIGVycm9yLiBkZWZhdWx0IHRvIG5vIHRyYWNlQ29uZmlnCgkJXyA9IGpzb24uVW5tYXJzaGFsKFtdYnl0ZShyZXEuVHJhY2VDb25maWcuVHJhY2VySnNvbkNvbmZpZyksICZhbXA7dHJhY2VyQ29uZmlnKQoJfQoKCXJlc3VsdCwgXywgZXJyIDo9IGsudHJhY2VUeChjdHgsIGNmZywgdHhDb25maWcsIHNpZ25lciwgdHgsIHJlcS5UcmFjZUNvbmZpZywgZmFsc2UsIHRyYWNlckNvbmZpZykKCWlmIGVyciAhPSBuaWwgewoJCS8vIGVycm9yIHdpbGwgYmUgcmV0dXJuZWQgd2l0aCBkZXRhaWwgc3RhdHVzIGZyb20gdHJhY2VUeAoJCXJldHVybiBuaWwsIGVycgoJfQoKCXJlc3VsdERhdGEsIGVyciA6PSBqc29uLk1hcnNoYWwocmVzdWx0KQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCBlcnIuRXJyb3IoKSkKCX0KCglyZXR1cm4gJmFtcDt0eXBlcy5RdWVyeVRyYWNlVHhSZXNwb25zZXsKCQlEYXRhOiByZXN1bHREYXRhLAoJfSwgbmlsCn0KCi8vIFRyYWNlQmxvY2sgY29uZmlndXJlcyBhIG5ldyB0cmFjZXIgYWNjb3JkaW5nIHRvIHRoZSBwcm92aWRlZCBjb25maWd1cmF0aW9uLCBhbmQKLy8gZXhlY3V0ZXMgdGhlIGdpdmVuIG1lc3NhZ2UgaW4gdGhlIHByb3ZpZGVkIGVudmlyb25tZW50IGZvciBhbGwgdGhlIHRyYW5zYWN0aW9ucyBpbiB0aGUgcXVlcmllZCBibG9jay4KLy8gVGhlIHJldHVybiB2YWx1ZSB3aWxsIGJlIHRyYWNlciBkZXBlbmRlbnQuCmZ1bmMgKGsgS2VlcGVyKSBUcmFjZUJsb2NrKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5VHJhY2VCbG9ja1JlcXVlc3QpICgqdHlwZXMuUXVlcnlUcmFjZUJsb2NrUmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWlmIHJlcS5UcmFjZUNvbmZpZyAhPSBuaWwgJmFtcDsmYW1wOyByZXEuVHJhY2VDb25maWcuTGltaXQgJmx0OyAwIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3JmKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7b3V0cHV0IGxpbWl0IGNhbm5vdCBiZSBuZWdhdGl2ZSwgZ290ICVkJnF1b3Q7LCByZXEuVHJhY2VDb25maWcuTGltaXQpCgl9CgoJLy8gbWludXMgb25lIHRvIGdldCB0aGUgY29udGV4dCBvZiBibG9jayBiZWdpbm5pbmcKCWNvbnRleHRIZWlnaHQgOj0gcmVxLkJsb2NrTnVtYmVyIC0gMQoJaWYgY29udGV4dEhlaWdodCAmbHQ7IDEgewoJCS8vIDAgaXMgYSBzcGVjaWFsIHZhbHVlIGluIGBDb250ZXh0V2l0aEhlaWdodGAKCQljb250ZXh0SGVpZ2h0ID0gMQoJfQoKCWN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjKQoJY3R4ID0gY3R4LldpdGhCbG9ja0hlaWdodChjb250ZXh0SGVpZ2h0KQoJY3R4ID0gY3R4LldpdGhCbG9ja1RpbWUocmVxLkJsb2NrVGltZSkKCWN0eCA9IGN0eC5XaXRoSGVhZGVySGFzaChjb21tb24uSGV4MkJ5dGVzKHJlcS5CbG9ja0hhc2gpKQoJY2hhaW5JRCwgZXJyIDo9IGdldENoYWluSUQoY3R4LCByZXEuQ2hhaW5JZCkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoKCWNmZywgZXJyIDo9IGsuRVZNQ29uZmlnKGN0eCwgR2V0UHJvcG9zZXJBZGRyZXNzKGN0eCwgcmVxLlByb3Bvc2VyQWRkcmVzcyksIGNoYWluSUQpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsICZxdW90O2ZhaWxlZCB0byBsb2FkIGV2bSBjb25maWcmcXVvdDspCgl9CglzaWduZXIgOj0gZXRodHlwZXMuTWFrZVNpZ25lcihjZmcuQ2hhaW5Db25maWcsIGJpZy5OZXdJbnQoY3R4LkJsb2NrSGVpZ2h0KCkpKQoJdHhzTGVuZ3RoIDo9IGxlbihyZXEuVHhzKQoJcmVzdWx0cyA6PSBtYWtlKFtdKnR5cGVzLlR4VHJhY2VSZXN1bHQsIDAsIHR4c0xlbmd0aCkKCgl0eENvbmZpZyA6PSBzdGF0ZWRiLk5ld0VtcHR5VHhDb25maWcoY29tbW9uLkJ5dGVzVG9IYXNoKGN0eC5IZWFkZXJIYXNoKCkuQnl0ZXMoKSkpCglmb3IgaSwgdHggOj0gcmFuZ2UgcmVxLlR4cyB7CgkJcmVzdWx0IDo9IHR5cGVzLlR4VHJhY2VSZXN1bHR7fQoJCWV0aFR4IDo9IHR4LkFzVHJhbnNhY3Rpb24oKQoJCXR4Q29uZmlnLlR4SGFzaCA9IGV0aFR4Lkhhc2goKQoJCXR4Q29uZmlnLlR4SW5kZXggPSB1aW50KGkpCgkJdHJhY2VSZXN1bHQsIGxvZ0luZGV4LCBlcnIgOj0gay50cmFjZVR4KGN0eCwgY2ZnLCB0eENvbmZpZywgc2lnbmVyLCBldGhUeCwgcmVxLlRyYWNlQ29uZmlnLCB0cnVlLCBuaWwpCgkJaWYgZXJyICE9IG5pbCB7CgkJCXJlc3VsdC5FcnJvciA9IGVyci5FcnJvcigpCgkJfSBlbHNlIHsKCQkJdHhDb25maWcuTG9nSW5kZXggPSBsb2dJbmRleAoJCQlyZXN1bHQuUmVzdWx0ID0gdHJhY2VSZXN1bHQKCQl9CgkJcmVzdWx0cyA9IGFwcGVuZChyZXN1bHRzLCAmYW1wO3Jlc3VsdCkKCX0KCglyZXN1bHREYXRhLCBlcnIgOj0ganNvbi5NYXJzaGFsKHJlc3VsdHMpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5VHJhY2VCbG9ja1Jlc3BvbnNlewoJCURhdGE6IHJlc3VsdERhdGEsCgl9LCBuaWwKfQoKLy8gdHJhY2VUeCBkbyB0cmFjZSBvbiBvbmUgdHJhbnNhY3Rpb24sIGl0IHJldHVybnMgYSB0dXBsZTogKHRyYWNlUmVzdWx0LCBuZXh0TG9nSW5kZXgsIGVycm9yKS4KZnVuYyAoayAqS2VlcGVyKSB0cmFjZVR4KAoJY3R4IHNkay5Db250ZXh0LAoJY2ZnICpzdGF0ZWRiLkVWTUNvbmZpZywKCXR4Q29uZmlnIHN0YXRlZGIuVHhDb25maWcsCglzaWduZXIgZXRodHlwZXMuU2lnbmVyLAoJdHggKmV0aHR5cGVzLlRyYW5zYWN0aW9uLAoJdHJhY2VDb25maWcgKnR5cGVzLlRyYWNlQ29uZmlnLAoJY29tbWl0TWVzc2FnZSBib29sLAoJdHJhY2VySlNPTkNvbmZpZyBqc29uLlJhd01lc3NhZ2UsCikgKCppbnRlcmZhY2V7fSwgdWludCwgZXJyb3IpIHsKCS8vIEFzc2VtYmxlIHRoZSBzdHJ1Y3R1cmVkIGxvZ2dlciBvciB0aGUgSmF2YVNjcmlwdCB0cmFjZXIKCXZhciAoCgkJdHJhY2VyICAgIHRyYWNlcnMuVHJhY2VyCgkJb3ZlcnJpZGVzICpldGhwYXJhbXMuQ2hhaW5Db25maWcKCQllcnIgICAgICAgZXJyb3IKCQl0aW1lb3V0ICAgPSBkZWZhdWx0VHJhY2VUaW1lb3V0CgkpCgltc2csIGVyciA6PSB0eC5Bc01lc3NhZ2Uoc2lnbmVyLCBjZmcuQmFzZUZlZSkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIDAsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgl9CgoJaWYgdHJhY2VDb25maWcgPT0gbmlsIHsKCQl0cmFjZUNvbmZpZyA9ICZhbXA7dHlwZXMuVHJhY2VDb25maWd7fQoJfQoKCWlmIHRyYWNlQ29uZmlnLk92ZXJyaWRlcyAhPSBuaWwgewoJCW92ZXJyaWRlcyA9IHRyYWNlQ29uZmlnLk92ZXJyaWRlcy5FdGhlcmV1bUNvbmZpZyhjZmcuQ2hhaW5Db25maWcuQ2hhaW5JRCkKCX0KCglsb2dDb25maWcgOj0gbG9nZ2VyLkNvbmZpZ3sKCQlFbmFibGVNZW1vcnk6ICAgICB0cmFjZUNvbmZpZy5FbmFibGVNZW1vcnksCgkJRGlzYWJsZVN0b3JhZ2U6ICAgdHJhY2VDb25maWcuRGlzYWJsZVN0b3JhZ2UsCgkJRGlzYWJsZVN0YWNrOiAgICAgdHJhY2VDb25maWcuRGlzYWJsZVN0YWNrLAoJCUVuYWJsZVJldHVybkRhdGE6IHRyYWNlQ29uZmlnLkVuYWJsZVJldHVybkRhdGEsCgkJRGVidWc6ICAgICAgICAgICAgdHJhY2VDb25maWcuRGVidWcsCgkJTGltaXQ6ICAgICAgICAgICAgaW50KHRyYWNlQ29uZmlnLkxpbWl0KSwKCQlPdmVycmlkZXM6ICAgICAgICBvdmVycmlkZXMsCgl9CgoJdHJhY2VyID0gbG9nZ2VyLk5ld1N0cnVjdExvZ2dlcigmYW1wO2xvZ0NvbmZpZykKCgl0Q3R4IDo9ICZhbXA7dHJhY2Vycy5Db250ZXh0ewoJCUJsb2NrSGFzaDogdHhDb25maWcuQmxvY2tIYXNoLAoJCVR4SW5kZXg6ICAgaW50KHR4Q29uZmlnLlR4SW5kZXgpLAoJCVR4SGFzaDogICAgdHhDb25maWcuVHhIYXNoLAoJfQoKCWlmIHRyYWNlQ29uZmlnLlRyYWNlciAhPSAmcXVvdDsmcXVvdDsgewoJCWlmIHRyYWNlciwgZXJyID0gdHJhY2Vycy5OZXcodHJhY2VDb25maWcuVHJhY2VyLCB0Q3R4LCB0cmFjZXJKU09OQ29uZmlnKTsgZXJyICE9IG5pbCB7CgkJCXJldHVybiBuaWwsIDAsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgkJfQoJfQoKCS8vIERlZmluZSBhIG1lYW5pbmdmdWwgdGltZW91dCBvZiBhIHNpbmdsZSB0cmFuc2FjdGlvbiB0cmFjZQoJaWYgdHJhY2VDb25maWcuVGltZW91dCAhPSAmcXVvdDsmcXVvdDsgewoJCWlmIHRpbWVvdXQsIGVyciA9IHRpbWUuUGFyc2VEdXJhdGlvbih0cmFjZUNvbmZpZy5UaW1lb3V0KTsgZXJyICE9IG5pbCB7CgkJCXJldHVybiBuaWwsIDAsIHN0YXR1cy5FcnJvcmYoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDt0aW1lb3V0IHZhbHVlOiAlcyZxdW90OywgZXJyLkVycm9yKCkpCgkJfQoJfQoKCS8vIEhhbmRsZSB0aW1lb3V0cyBhbmQgUlBDIGNhbmNlbGxhdGlvbnMKCWRlYWRsaW5lQ3R4LCBjYW5jZWwgOj0gY29udGV4dC5XaXRoVGltZW91dChjdHguQ29udGV4dCgpLCB0aW1lb3V0KQoJZGVmZXIgY2FuY2VsKCkKCglnbyBmdW5jKCkgewoJCSZsdDstZGVhZGxpbmVDdHguRG9uZSgpCgkJaWYgZXJyb3JzLklzKGRlYWRsaW5lQ3R4LkVycigpLCBjb250ZXh0LkRlYWRsaW5lRXhjZWVkZWQpIHsKCQkJdHJhY2VyLlN0b3AoZXJyb3JzLk5ldygmcXVvdDtleGVjdXRpb24gdGltZW91dCZxdW90OykpCgkJfQoJfSgpCgoJcmVzLCBlcnIgOj0gay5BcHBseU1lc3NhZ2VXaXRoQ29uZmlnKGN0eCwgbXNnLCB0cmFjZXIsIGNvbW1pdE1lc3NhZ2UsIGNmZywgdHhDb25maWcpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCAwLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCXZhciByZXN1bHQgaW50ZXJmYWNle30KCXJlc3VsdCwgZXJyID0gdHJhY2VyLkdldFJlc3VsdCgpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCAwLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCXJldHVybiAmYW1wO3Jlc3VsdCwgdHhDb25maWcuTG9nSW5kZXggKyB1aW50KGxlbihyZXMuTG9ncykpLCBuaWwKfQoKLy8gQmFzZUZlZSBpbXBsZW1lbnRzIHRoZSBRdWVyeS9CYXNlRmVlIGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBCYXNlRmVlKGMgY29udGV4dC5Db250ZXh0LCBfICp0eXBlcy5RdWVyeUJhc2VGZWVSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5QmFzZUZlZVJlc3BvbnNlLCBlcnJvcikgewoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCgoJcGFyYW1zIDo9IGsuR2V0UGFyYW1zKGN0eCkKCWV0aENmZyA6PSBwYXJhbXMuQ2hhaW5Db25maWcuRXRoZXJldW1Db25maWcoay5laXAxNTVDaGFpbklEKQoJYmFzZUZlZSA6PSBrLkdldEJhc2VGZWUoY3R4LCBldGhDZmcpCgoJcmVzIDo9ICZhbXA7dHlwZXMuUXVlcnlCYXNlRmVlUmVzcG9uc2V7fQoJaWYgYmFzZUZlZSAhPSBuaWwgewoJCWF1eCA6PSBzZGttYXRoLk5ld0ludEZyb21CaWdJbnQoYmFzZUZlZSkKCQlyZXMuQmFzZUZlZSA9ICZhbXA7YXV4Cgl9CgoJcmV0dXJuIHJlcywgbmlsCn0KCi8vIGdldENoYWluSUQgcGFyc2UgY2hhaW5JRCBmcm9tIGN1cnJlbnQgY29udGV4dCBpZiBub3QgcHJvdmlkZWQKZnVuYyBnZXRDaGFpbklEKGN0eCBzZGsuQ29udGV4dCwgY2hhaW5JRCBpbnQ2NCkgKCpiaWcuSW50LCBlcnJvcikgewoJaWYgY2hhaW5JRCA9PSAwIHsKCQlyZXR1cm4gaGFxcXR5cGVzLlBhcnNlQ2hhaW5JRChjdHguQ2hhaW5JRCgpKQoJfQoJcmV0dXJuIGJpZy5OZXdJbnQoY2hhaW5JRCksIG5pbAp9Cg=="}})],1)])}),[],!1,null,null,null);c.default=d.exports}}]);